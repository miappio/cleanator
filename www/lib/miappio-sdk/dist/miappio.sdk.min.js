function openChildBrowser(url,extension,onLocationChange,onClose){var closeChildBrowserAfterLocationChange=!1;if(!window.device){miapp.InternalLog.log("openChildBrowser","window.open");var initialLocation,initialUrl,new_window=window.open(url,"_blank","menubar=no,scrollbars=yes,resizable=1,height=400,width=600");miapp.isDefinedAndNotNull(new_window.location)&&(initialLocation=new_window.location.href),miapp.isDefinedAndNotNull(new_window.document)&&(initialUrl=new_window.document.URL),miapp.InternalLog.log("openChildBrowser","initialLocation="+initialLocation+" initialUrl="+initialUrl);var locationChanged=!1,new_window_tracker=function(){if(miapp.isDefinedAndNotNull(new_window.location)&&"string"==typeof new_window.location.href||miapp.isDefinedAndNotNull(new_window.document)&&"string"==typeof new_window.document.URL,locationChanged){if(miapp.isDefinedAndNotNull(new_window.location)&&"string"==typeof new_window.location.href&&new_window.location.href.indexOf("about:blank")>=0)return miapp.InternalLog.log("openChildBrowser","onLocationChange"),onLocationChange&&onLocationChange(),closeChildBrowserAfterLocationChange=!0,void new_window.close();if(miapp.isDefinedAndNotNull(new_window.document)&&"string"==typeof new_window.document.URL&&new_window.document.URL.indexOf("about:blank")>=0)return miapp.InternalLog.log("openChildBrowser","onUrlChange"),onLocationChange&&onLocationChange(),closeChildBrowserAfterLocationChange=!0,void new_window.close()}else{if(miapp.isDefinedAndNotNull(new_window.location)&&"string"==typeof new_window.location.href&&initialLocation!=new_window.location.href)return miapp.InternalLog.log("openChildBrowser","new location="+new_window.location.href),locationChanged=!0,void setTimeout(new_window_tracker,100);if(miapp.isDefinedAndNotNull(new_window.document)&&"string"==typeof new_window.document.URL&&initialUrl!=new_window.document.URL)return miapp.InternalLog.log("openChildBrowser","new url="+new_window.document.URL),locationChanged=!0,void setTimeout(new_window_tracker,100)}return new_window.closed?(miapp.InternalLog.log("openChildBrowser","onClose"),void(closeChildBrowserAfterLocationChange||onClose&&onClose())):void setTimeout(new_window_tracker,100)};return void setTimeout(new_window_tracker,100)}miapp.InternalLog.log("openChildBrowser","cordova : window.open");var target="_blank";"url"!=extension&&"Android"===window.device.platform&&(target="_system");var ref=window.open(url,target,"location=no");ref.addEventListener("loadstart",function(e){miapp.InternalLog.log("openChildBrowser","loadstart "+e.url)}),ref.addEventListener("loadstop",function(e){miapp.InternalLog.log("openChildBrowser","loadstop "+e.url),"string"==typeof e.url&&e.url.indexOf("about:blank")>=0&&(closeChildBrowserAfterLocationChange=!0,onLocationChange&&onLocationChange(),ref.close())}),ref.addEventListener("loaderror",function(e){miapp.InternalLog.log("openChildBrowser","loaderror "+e.url)}),ref.addEventListener("exit",function(e){miapp.InternalLog.log("openChildBrowser","exit "+e.url),closeChildBrowserAfterLocationChange||onClose&&onClose()})}function closeWindow(){window.close()}function isArray(obj){return obj instanceof Array||"object"==typeof obj&&(!miapp.isUndefined(obj)&&null!==obj&&"[object Array]"===Object.prototype.toString.call(obj))}function updateImage(source,img){return img&&"/."!=img?source.src=img:source.src="./img/broken.png",source.onerror="",!0}function ImgError(source,img){return setTimeout(function(){updateImage(source,img)},1e4),!1}function getErrorObject(){try{throw Error("")}catch(err){return err}}function miappExportJson(input,maxDepth){var key,type,str="{\n",first=!0;for(key in input)input.hasOwnProperty(key)&&("Contact"!=key&&"Attendee"!=key&&"Account"!=key&&"Opportunity"!=key&&"Event"!=key&&"Document"!=key||(type=key,first?first=!1:str+=",\n",str+='\t"'+key+'":[\n',"object"==typeof input[key]&&maxDepth>0&&(str+=miappExportJsonObject("\t\t",input[key],maxDepth-1,type)),str+="\t]"));return str+="\n}\n"}function miappExportJsonObject(offset,input,maxDepth,type){var key,str="",first=!0;for(key in input)input.hasOwnProperty(key)&&(first?first=!1:str+=",\n","object"==typeof input[key]?maxDepth>0&&(str+=2==maxDepth?offset+"{\n":offset+'"'+key+'":{',str+=miappExportJsonObject(offset+"\t",input[key],maxDepth-1,type),str+=2==maxDepth?offset+"}":"}"):("string"==typeof input[key]&&(input[key]=input[key].replace(/\r/gi," ").replace(/\n/gi," ")),str+=0===maxDepth?'"'+key+'":"'+input[key]+'"':offset+'"'+key+'":"'+input[key]+'"'));return 1==maxDepth&&"Document"==type&&(str+=",\n"+offset+'"url":"img/samples/docs/'+input.name+'"'),0!==maxDepth&&(str+="\n"),str}function logEvent(e){var online,status,type,message,bCon=checkConnection();online=bCon?"yes":"no",status=cacheStatusValues[cache.status],type=e.type,message="CACHE online: "+online,message+=", event: "+type,message+=", status: "+status,"error"==type&&bCon&&(message+=" (prolly a syntax error in manifest)"),miapp.InternalLog.log(message)}function checkCache(){cache&&(cacheStatusValues[0]="uncached",cacheStatusValues[1]="idle",cacheStatusValues[2]="checking",cacheStatusValues[3]="downloading",cacheStatusValues[4]="updateready",cacheStatusValues[5]="obsolete",cache.addEventListener("cached",logEvent,!1),cache.addEventListener("checking",logEvent,!1),cache.addEventListener("downloading",logEvent,!1),cache.addEventListener("error",logEvent,!1),cache.addEventListener("noupdate",logEvent,!1),cache.addEventListener("obsolete",logEvent,!1),cache.addEventListener("progress",logEvent,!1),cache.addEventListener("updateready",logEvent,!1))}function checkConnection(){var bCon=!1;if(miapp.InternalLog.log("checkConnection","launched"),navigator.connection&&navigator.connection.type){var networkState=navigator.connection.type,states={};states[Connection.UNKNOWN]="Unknown connection",states[Connection.ETHERNET]="Ethernet connection",states[Connection.WIFI]="WiFi connection",states[Connection.CELL_2G]="Cell 2G connection",states[Connection.CELL_3G]="Cell 3G connection",states[Connection.CELL_4G]="Cell 4G connection",states[Connection.CELL]="Cell generic connection",states[Connection.NONE]="No network connection",miapp.InternalLog.log("checkConnection","Cordova Connection type: "+states[networkState]),bCon=networkState!=Connection.NONE}else miapp.BrowserCapabilities&&miapp.BrowserCapabilities.online?bCon=!0:miapp.BrowserCapabilities||(bCon=navigator.onLine),miapp.InternalLog.log("checkConnection","without Cordova but online ? "+bCon);return bCon}function getUrlVars(ihref){var href=ihref;!miapp.isUndefined(href)&&href||(href=window.location.href),miapp.InternalLog.log("getUrlVars","href:"+href);for(var hash,vars=[],hashes=href.slice(href.indexOf("#")+1).split("&"),i=0;i<hashes.length;i++)hash=hashes[i].split("="),vars.push(hash[0]),vars[hash[0]]=hash[1];return vars}function SHA256(s){function safe_add(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}function S(X,n){return X>>>n|X<<32-n}function R(X,n){return X>>>n}function Ch(x,y,z){return x&y^~x&z}function Maj(x,y,z){return x&y^x&z^y&z}function Sigma0256(x){return S(x,2)^S(x,13)^S(x,22)}function Sigma1256(x){return S(x,6)^S(x,11)^S(x,25)}function Gamma0256(x){return S(x,7)^S(x,18)^R(x,3)}function Gamma1256(x){return S(x,17)^S(x,19)^R(x,10)}function core_sha256(m,l){var a,b,c,d,e,f,g,h,i,j,T1,T2,K=new Array(1116352408,1899447441,3049323471,3921009573,961987163,1508970993,2453635748,2870763221,3624381080,310598401,607225278,1426881987,1925078388,2162078206,2614888103,3248222580,3835390401,4022224774,264347078,604807628,770255983,1249150122,1555081692,1996064986,2554220882,2821834349,2952996808,3210313671,3336571891,3584528711,113926993,338241895,666307205,773529912,1294757372,1396182291,1695183700,1986661051,2177026350,2456956037,2730485921,2820302411,3259730800,3345764771,3516065817,3600352804,4094571909,275423344,430227734,506948616,659060556,883997877,958139571,1322822218,1537002063,1747873779,1955562222,2024104815,2227730452,2361852424,2428436474,2756734187,3204031479,3329325298),HASH=new Array(1779033703,3144134277,1013904242,2773480762,1359893119,2600822924,528734635,1541459225),W=new Array(64);for(m[l>>5]|=128<<24-l%32,m[(l+64>>9<<4)+15]=l,i=0;i<m.length;i+=16){for(a=HASH[0],b=HASH[1],c=HASH[2],d=HASH[3],e=HASH[4],f=HASH[5],g=HASH[6],h=HASH[7],j=0;j<64;j++)j<16?W[j]=m[j+i]:W[j]=safe_add(safe_add(safe_add(Gamma1256(W[j-2]),W[j-7]),Gamma0256(W[j-15])),W[j-16]),T1=safe_add(safe_add(safe_add(safe_add(h,Sigma1256(e)),Ch(e,f,g)),K[j]),W[j]),T2=safe_add(Sigma0256(a),Maj(a,b,c)),h=g,g=f,f=e,e=safe_add(d,T1),d=c,c=b,b=a,a=safe_add(T1,T2);HASH[0]=safe_add(a,HASH[0]),HASH[1]=safe_add(b,HASH[1]),HASH[2]=safe_add(c,HASH[2]),HASH[3]=safe_add(d,HASH[3]),HASH[4]=safe_add(e,HASH[4]),HASH[5]=safe_add(f,HASH[5]),HASH[6]=safe_add(g,HASH[6]),HASH[7]=safe_add(h,HASH[7])}return HASH}function str2binb(str){for(var bin=Array(),mask=(1<<chrsz)-1,i=0;i<str.length*chrsz;i+=chrsz)bin[i>>5]|=(str.charCodeAt(i/chrsz)&mask)<<24-i%32;return bin}function Utf8Encode(string){if(0===string.length)return string;string=string.replace(/\r\n/g,"\n");for(var utftext="",n=0;n<string.length;n++){var c=string.charCodeAt(n);c<128?utftext+=String.fromCharCode(c):c>127&&c<2048?(utftext+=String.fromCharCode(c>>6|192),utftext+=String.fromCharCode(63&c|128)):(utftext+=String.fromCharCode(c>>12|224),utftext+=String.fromCharCode(c>>6&63|128),utftext+=String.fromCharCode(63&c|128))}return utftext}function binb2hex(binarray){for(var hex_tab=hexcase?"0123456789ABCDEF":"0123456789abcdef",str="",i=0;i<4*binarray.length;i++)str+=hex_tab.charAt(binarray[i>>2]>>8*(3-i%4)+4&15)+hex_tab.charAt(binarray[i>>2]>>8*(3-i%4)&15);return str}if(0===s.length)return"";var chrsz=8,hexcase=0;return s=Utf8Encode(s),binb2hex(core_sha256(str2binb(s),s.length*chrsz))}function successHandler(data){miapp.InternalLog.log("Analytics","initialization success : "+data)}function errorHandler(data){miapp.InternalLog.log("Analytics","initialization pb : "+data)}function miappDumpData(input,maxDepth){var str="";return"object"==typeof input?input instanceof Array?maxDepth>0?(str+="[\n",str+=miappDumpArray("  ",input,maxDepth-1),str+="]\n"):str+="[Array]\n":maxDepth>0?(str+="{\n",str+=miappDumpObject("  ",input,maxDepth-1),str+="}\n"):str+="["+typeof input+"]\n":str+=input+"\n",str}function miappDumpArray(offset,input,maxDepth){for(var str="",key=0,nb=input.length;key<nb;key++)"object"==typeof input[key]?input[key]instanceof Array?maxDepth>0?(str+=offset+key+" : [\n",str+=miappDumpArray(offset+"  ",input[key],maxDepth-1),str+=offset+"]\n"):str+=offset+key+" : [Array]\n":maxDepth>0?(str+=offset+key+" : {\n",str+=miappDumpObject(offset+"  ",input[key],maxDepth-1),str+=offset+"}\n"):str+=offset+key+" : ["+typeof input[key]+"]\n":str+=offset+key+" : "+input[key]+"\n";return str}function miappDumpObject(offset,input,maxDepth){var key,str="";for(key in input)input.hasOwnProperty(key)&&("object"==typeof input[key]?input[key]instanceof Array?maxDepth>0?(str+=offset+key+" : [\n",str+=miappDumpArray(offset+"  ",input[key],maxDepth-1),str+=offset+"]\n"):str+=offset+key+" : [Array]\n":maxDepth>0?(str+=offset+key+" : {\n",str+=miappDumpObject(offset+"  ",input[key],maxDepth-1),str+=offset+"}\n"):str+=offset+key+" : ["+typeof input[key]+"]\n":str+=offset+key+" : "+input[key]+"\n");return str}function miappTimestampFormat(timestamp){var date=new Date(timestamp);return miappPadNumber(date.getFullYear(),4)+"-"+miappPadNumber(date.getMonth()+1,2)+"-"+miappPadNumber(date.getDate(),2)+" "+miappPadNumber(date.getHours(),2)+":"+miappPadNumber(date.getMinutes(),2)+":"+miappPadNumber(date.getSeconds(),2)}function miappDateFormat(date){return date?miappPadNumber(date.getFullYear(),4)+"-"+miappPadNumber(date.getMonth()+1,2)+"-"+miappPadNumber(date.getDate(),2)+" "+miappPadNumber(date.getHours(),2)+":"+miappPadNumber(date.getMinutes(),2)+":"+miappPadNumber(date.getSeconds(),2):""}function miappDateCompactFormat(date){return date?miappPadNumber(date.getFullYear(),2)+miappPadNumber(date.getMonth()+1,2)+miappPadNumber(date.getDate(),2)+"_"+miappPadNumber(date.getHours(),2)+miappPadNumber(date.getMinutes(),2)+miappPadNumber(date.getSeconds(),2):""}function miappTimestampParse(date){var newDate=miappDateParse(date);return newDate!==!1?newDate.getTime():0}function miappDateParse(date){if(!date||"string"!=typeof date||""==date)return!1;var yearS=parseInt(date.substr(0,4),10)||0,monthS=parseInt(date.substr(5,2),10)||0,dayS=parseInt(date.substr(8,2),10)||0,hourS=parseInt(date.substr(11,2),10)||0,minuteS=parseInt(date.substr(14,2),10)||0,secS=parseInt(date.substr(17,2),10)||0,newDate=new Date(yearS,monthS-1,dayS,hourS,minuteS,secS,0);return newDate.getFullYear()===yearS&&newDate.getMonth()===monthS-1&&newDate.getDate()===dayS&&newDate}function miappDateFormatObject(object){var yearS="1970",monthS="01",dayS="01",hourS="00",minuteS="00",secondS="00";if("[object Date]"===Object.prototype.toString.call(object))isNaN(object.getTime())||(yearS=""+object.getFullYear(),monthS=""+(object.getMonth()+1),dayS=""+object.getDate(),hourS=""+object.getHours(),minuteS=""+object.getMinutes(),secondS=""+object.getSeconds());else if("string"==typeof object){var dateReg=new RegExp("([0-9][0-9][0-9][0-9])-([0-9]\\d)-([0-9]\\d)+","g"),dateParts=object.split(dateReg);yearS=dateParts[1]||"0",monthS=dateParts[2]||"0",dayS=dateParts[3]||"0";var timeReg=new RegExp("([01]\\d|2[0-9]):([0-5]\\d):([0-5]\\d)"),timeParts=object.match(timeReg);null!=timeParts?(hourS=timeParts[1]||"00",minuteS=timeParts[2]||"00",secondS=timeParts[3]||"00"):(hourS="00",minuteS="00",secondS="00")}for(;yearS.length<4;)yearS="0"+yearS;for(;monthS.length<2;)monthS="0"+monthS;for(;dayS.length<2;)dayS="0"+dayS;for(;hourS.length<2;)hourS="0"+hourS;for(;minuteS.length<2;)minuteS="0"+minuteS;for(;secondS.length<2;)secondS="0"+secondS;var newDate=yearS+"-"+monthS+"-"+dayS+" "+hourS+":"+minuteS+":"+secondS;return newDate}function miappDateExtractDate(dateString){for(var dateReg=new RegExp("([0-9][0-9][0-9][0-9])-([0-9]\\d)-([0-9]\\d)+","g"),dateParts=dateString.split(dateReg),yearS=dateParts[1]||"0",monthS=dateParts[2]||"0",dayS=dateParts[3]||"0";yearS.length<4;)yearS="0"+yearS;for(;monthS.length<2;)monthS="0"+monthS;for(;dayS.length<2;)dayS="0"+dayS;return""+yearS+"-"+monthS+"-"+dayS}function miappDateExtractTime(dateString){var timeReg=new RegExp("([01]\\d|2[0-9]):([0-5]\\d):([0-5]\\d)"),timeParts=dateString.match(timeReg),hourS="00",minuteS="00",secondS="00";for(null!=timeParts?(hourS=timeParts[1]||"00",minuteS=timeParts[2]||"00",secondS=timeParts[3]||"00"):(hourS="00",minuteS="00",secondS="00");hourS.length<2;)hourS="0"+hourS;for(;minuteS.length<2;)minuteS="0"+minuteS;for(;secondS.length<2;)secondS="0"+secondS;return""+hourS+":"+minuteS+":"+secondS}function miappPadNumber(num,digits,trim){var neg="";for(num<0&&(neg="-",num=-num),num=""+num;num.length<digits;)num="0"+num;return trim&&num.length>digits&&(num=num.substr(num.length-digits)),neg+num}function extend(subClass,superClass){var F=function(){};return F.prototype=superClass.prototype,subClass.prototype=new F,subClass.prototype.constructor=subClass,subClass.superclass=superClass.prototype,superClass.prototype.constructor==Object.prototype.constructor&&(superClass.prototype.constructor=superClass),subClass}function propCopy(from,to){for(var prop in from)from.hasOwnProperty(prop)&&("object"==typeof from[prop]&&"object"==typeof to[prop]?to[prop]=propCopy(from[prop],to[prop]):to[prop]=from[prop]);return to}function NOOP(){}function isValidUrl(url){if(!url)return!1;var doc,base,anchor,isValid=!1;try{doc=document.implementation.createHTMLDocument(""),base=doc.createElement("base"),base.href=base||window.lo,doc.head.appendChild(base),anchor=doc.createElement("a"),anchor.href=url,doc.body.appendChild(anchor),isValid=!(""===anchor.href)}catch(e){}finally{return doc.head.removeChild(base),doc.body.removeChild(anchor),base=null,anchor=null,doc=null,isValid}}function isUUID(uuid){return!!uuid&&uuidValueRegex.test(uuid)}function encodeParams(params){var queryString;return params&&Object.keys(params)&&(queryString=[].slice.call(arguments).reduce(function(a,b){return a.concat(b instanceof Array?b:[b])},[]).filter(function(c){return"object"==typeof c}).reduce(function(p,c){return c instanceof Array?p.push(c):p=p.concat(Object.keys(c).map(function(key){return[key,c[key]]})),p},[]).reduce(function(p,c){return 2===c.length?p.push(c):p=p.concat(c),p},[]).reduce(function(p,c){return c[1]instanceof Array?c[1].forEach(function(v){p.push([c[0],v])}):p.push(c),p},[]).map(function(c){return c[1]=encodeURIComponent(c[1]),c.join("=")}).join("&")),queryString}function isFunction(f){return f&&null!==f&&"function"==typeof f}function doCallback(callback,params,context){var returnValue;return isFunction(callback)&&(params||(params=[]),context||(context=this),params.push(context),returnValue=callback.apply(context,params)),returnValue}function getSafeTime(prop){var time;switch(typeof prop){case"undefined":time=Date.now();break;case"number":time=prop;break;case"string":time=isNaN(prop)?Date.parse(prop):parseInt(prop);break;default:time=Date.parse(prop.toString())}return time}var miappBlockMove=function(evt,stopBubble){"use strict";evt.preventDefault&&!$(".c4p-container-scroll-y").has($(evt.target)).length&&evt.preventDefault(),stopBubble&&evt.stopPropagation&&evt.stopPropagation(),stopBubble&&!evt.cancelBubble&&(evt.cancelBubble=!0)},miappAllowMove=function(e){return!0},miappFakeConsoleLog=function(e){return!0},LocalFileSystem,Metadata,FileError,ProgressEvent,File,DirectoryEntry,DirectoryReader,FileWriter,FileEntry,FileSystem,FileReader,FileTransferError,FileUploadOptions,FileUploadResult,FileTransfer,Camera,miapp;miapp||(miapp={}),miapp.uid=["0","0","0"],miapp.idStr="0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZ",miapp.idNext={0:1,1:2,2:3,3:4,4:5,5:6,6:7,7:8,8:9,9:10,A:11,B:12,C:13,D:14,E:15,F:16,G:17,H:18,I:19,J:20,K:21,L:22,M:23,N:24,O:25,P:26,Q:27,R:28,S:29,T:30,U:31,V:32,W:33,X:34,Y:35,Z:0},miapp.nextUid=function(){for(var index=miapp.uid.length;index;){index--;var i=miapp.idNext[miapp.uid[index]];if(miapp.uid[index]=miapp.idStr[i],i>0)return miapp.uid.join("")}return miapp.uid.unshift("0"),miapp.uid.join("")},miapp.getUid=function(){return miapp.uid.join("")},miapp.initUid=function(seed){if(miapp.isUndefined(seed))return void(miapp.uid=["0","0","0"]);seed=seed.toUpperCase(),miapp.uid=[];for(var i=0,n=seed.length;i<n;i++){var c=seed.charAt(i);miapp.isDefined(miapp.idNext[c])&&miapp.uid.push(c)}for(;miapp.uid.length<3;)miapp.uid.unshift("0")},miapp.isUndefined=function(obj){return"undefined"==typeof obj},miapp.isDefined=function(obj){return"undefined"!=typeof obj},miapp.isUndefinedOrNull=function(obj){return"undefined"==typeof obj||null===obj},miapp.isDefinedAndNotNull=function(obj){return"undefined"!=typeof obj&&null!==obj},miapp.isEmptyOrFalse=function(obj){"use strict";switch(typeof obj){case"object":return null===obj||(0===Object.getOwnPropertyNames(obj).length||obj instanceof Array&&0===obj.length);case"string":return 0===obj.length;case"number":return 0===obj;case"boolean":return!obj;case"function":return!1;case"undefined":return!0}return!obj},miapp.isTrueOrNonEmpty=function(obj){switch(typeof obj){case"object":return null!==obj&&(0!==Object.getOwnPropertyNames(obj).length&&(!(obj instanceof Array)||0!==obj.length));case"string":return 0!==obj.length;case"number":return 0!==obj;case"boolean":return obj;case"function":return!0;case"undefined":return!1}return!!obj},miapp.safeApply=function(scope,expr,beforeFct,afterFct){beforeFct&&miapp.safeApply(scope,beforeFct),scope.$root&&scope.$root.$$phase?scope.$root.$evalAsync(function(){scope.$eval(expr)}):scope.$treeScope&&scope.$treeScope.$apply?scope.$treeScope.$apply(expr):scope.$apply&&scope.$apply!=angular.noop?scope.$apply(expr):expr(),afterFct&&miapp.safeApply(scope,afterFct)},miapp.promiseWakeupNb=0,miapp.promiseWakeupTimeout=null,miapp.promiseWakeup=function(scope,httpPromise,fctOnHttpSuccess,fctOnHttpError){function tick(){miapp.promiseWakeupNb>0&&(miapp.safeApply(scope),miapp.promiseWakeupTimeout=setTimeout(tick,1e3))}var promiseWakeupOnHttpSuccess=function(response){miapp.promiseWakeupNb--,miapp.promiseWakeupNb<=0&&(miapp.InternalLog.log("miapp.promiseWakeup.tick","stop"),miapp.promiseWakeupNb=0,clearTimeout(miapp.promiseWakeupTimeout),miapp.promiseWakeupTimeout=null),fctOnHttpSuccess(response)},promiseWakeupOnHttpError=function(response){miapp.promiseWakeupNb--,miapp.promiseWakeupNb<=0&&(miapp.InternalLog.log("miapp.promiseWakeup.tick","stop"),miapp.promiseWakeupNb=0,clearTimeout(miapp.promiseWakeupTimeout),miapp.promiseWakeupTimeout=null),fctOnHttpError(response)};0===miapp.promiseWakeupNb&&(miapp.promiseWakeupTimeout=setTimeout(tick,1e3)),miapp.promiseWakeupNb++,httpPromise.then(promiseWakeupOnHttpSuccess,promiseWakeupOnHttpError)};var cache=window.applicationCache,cacheStatusValues=[],miappTranslateDatesToPxSize=function(date_start,date_end,totalSize){var date1=date_start;if("string"==typeof date1&&(date1=miappDateParse(date_start)),!date1)return totalSize;var date2=date_end;if("string"==typeof date2&&(date2=miappDateParse(date_end)),!date2)return totalSize;var milliseconds=date2.getTime()-date1.getTime();if(milliseconds<0)return totalSize;var days=milliseconds/1e3/86400;return days>1&&(days=1),Math.round(days*totalSize)},miappTranslateDateToPx=function(date,totalSize){var date1=date;if("string"==typeof date1&&(date1=miappDateParse(date)),!date1)return 0;var days=(60*date1.getHours()+date1.getMinutes())/1440;return Math.round(days*totalSize)};miapp.not=function(f){return function(){var result=f.apply(this,arguments);return!result}},miapp.mapper=function(f){return function(a){return map(a,f)}},miapp.memoize=function(f){var cache={};return function(){var key=arguments.length+Array.prototype.join.call(arguments,",");return key in cache?cache.key:(cache.key=f.apply(this,arguments),cache.key)}},miapp.extend=function(o,p){for(var prop in p)o[prop]=p[prop];return o},miapp.merge=function(o,p){for(var prop in p)o.hasOwnProperty(prop)||(o[prop]=p[prop]);return o},miapp.restrict=function(o,p){for(var prop in o)prop in p||delete o[prop];return o},miapp.subtract=function(o,p){for(var prop in p)delete o[prop];return o},miapp.union=function(o,p){return miapp.extend(miapp.extend({},o),p)},miapp.intersection=function(o,p){return miapp.restrict(miapp.extend({},o),p)},miapp.keys=function(o){if("object"!=typeof o)throw new TypeError;var result=[];for(var prop in o)o.hasOwnProperty(prop)&&result.push(prop);return result},miapp.create=function(proto,props){function F(){}if(null===proto)throw new TypeError;if(Object.create)return Object.create(proto,props);var t=typeof proto;if("object"!==t&&"function"!==t)throw new TypeError;F.prototype=proto;var o=new F;return miapp.extend(o,props)},miapp.even=function(x){return x%2===0},miapp.odd=miapp.not(miapp.even),miapp.foreach=function(a,f,t){try{a.forEach(f,t)}catch(e){if(e===miapp.foreach.break)return;throw e}},miapp.foreach.break=new Error("StopIteration");var miapp;miapp||(miapp={}),miapp.Analytics=function(){"use strict";function Analytics(localStorage,googleAnalytics_UA_ID){this.localStorage=null,miapp.isDefined(localStorage)&&localStorage&&(this.localStorage=localStorage),this.mAnalyticsArray=[],this.mAnalyticsFunctionnalitiesArray=[],this.localStorage&&(this.mAnalyticsArray=this.localStorage.get(mAnalyticsLS,this.mAnalyticsArray),this.mAnalyticsFunctionnalitiesArray=this.localStorage.get(mAnalyticsFunctionnalitiesLS,this.mAnalyticsFunctionnalitiesArray)),this.vid="vid_undefined",this.uid="uid_undefined",this.initDone=!1,this.bEnabled=!0,this.googleAnalytics_UA_ID=googleAnalytics_UA_ID,this.gaQueue=null,this.gaPanalytics=null,this.gaPlugin=null}var mAnalyticsLS="miapp.Analytics",mAnalyticsFunctionnalitiesLS="miapp.Analytics.functionalities";return Analytics.prototype.init=function(){this.initDone||("undefined"!=typeof _gaq?(miapp.InternalLog.log("Analytics","googleAnalytics official launched."),this.gaQueue=_gaq||[],this.gaQueue.push(["_setAccount",this.googleAnalytics_UA_ID]),this.gaQueue.push(["_trackPageview"])):miapp.InternalLog.log("Analytics","googleAnalytics not defined."),"undefined"!=typeof window.plugins&&"undefined"!=typeof window.plugins.gaPlugin&&(miapp.InternalLog.log("Analytics","GAPlugin launched."),this.gaPlugin=window.plugins.gaPlugin,this.gaPlugin.init(successHandler,errorHandler,this.googleAnalytics_UA_ID,10)),this.initDone=!0)},Analytics.prototype.setVid=function(vid){this.vid=vid,miapp.InternalLog.log("Analytics","set vid "+this.vid)},Analytics.prototype.setUid=function(uid){miapp.InternalLog.log("Analytics","set uid "+uid),uid&&""!==uid&&(this.uid=uid)},Analytics.prototype.setEnabled=function(enable){this.bEnabled=enable===!0,miapp.InternalLog.log("Analytics","set enabled "+this.bEnabled)},Analytics.prototype.add=function(category,action,value){if(this.bEnabled&&category&&action){var shouldBeTrackedAsEvent=!0;if("Once"==category){for(var i=0;i<this.mAnalyticsFunctionnalitiesArray.length&&shouldBeTrackedAsEvent;i++)this.mAnalyticsFunctionnalitiesArray[i]===action&&(shouldBeTrackedAsEvent=!1);shouldBeTrackedAsEvent&&this.mAnalyticsFunctionnalitiesArray.push(action)}miapp.InternalLog.log("Analytics","shouldBeTrackedAsEvent ?"+shouldBeTrackedAsEvent);var paramEvent={vid:this.vid,uid:this.uid,type:"event",category:category,action:action,value:value||1},paramView={vid:this.vid,uid:this.uid,type:"view",category:category,action:action,value:value||1};miapp.InternalLog.log("Analytics","add "+paramEvent.toString()),shouldBeTrackedAsEvent&&this.mAnalyticsArray.push(paramEvent),this.mAnalyticsArray.push(paramView),this.localStorage&&this.localStorage.set(mAnalyticsLS,this.mAnalyticsArray),this.localStorage&&this.localStorage.set(mAnalyticsFunctionnalitiesLS,this.mAnalyticsFunctionnalitiesArray),checkConnection()&&this.run()}},Analytics.prototype.run=function(){if(this.bEnabled){miapp.InternalLog.log("Analytics","run - pushing "+this.mAnalyticsArray.length+" elements");var bOK=!0;try{for(var i=0;i<this.mAnalyticsArray.length;i++){var param=this.mAnalyticsArray[i];if("view"==param.type){var url=""+this.vid+" - "+param.category+" - "+param.action;miapp.InternalLog.log("Analytics","track view "+url),this.gaQueue&&this.gaQueue.push(["_trackPageview",url]),this.gaPanalytics&&this.gaPanalytics.trackView(url),this.gaPlugin&&this.gaPlugin.trackPage(successHandler,errorHandler,url)}else{var cat=this.vid+" - "+param.category,act=param.category+" - "+param.action,lab=param.uid,val=param.value;miapp.InternalLog.log("Analytics","track event "+cat+", "+act+", "+lab+", "+val),this.gaQueue&&this.gaQueue.push(["_trackEvent",cat,act,lab,val]),this.gaPanalytics&&this.gaPanalytics.trackEvent(cat,act,lab,val),this.gaPlugin&&this.gaPlugin.trackEvent(successHandler,errorHandler,cat,act,lab,val)}}}catch(e){miapp.ErrorLog.log("Analytics"," run pb : "+miapp.formatError(e)),bOK=!1}bOK&&(this.mAnalyticsArray=[],this.localStorage&&this.localStorage.set(mAnalyticsLS,this.mAnalyticsArray))}},Analytics}();var miapp;miapp||(miapp={}),miapp.Base64=function(){"use strict";function uint6ToB64(nUint6){return nUint6<26?nUint6+65:nUint6<52?nUint6+71:nUint6<62?nUint6-4:62===nUint6?43:63===nUint6?47:65}function b64ToUint6(nChr){return nChr>64&&nChr<91?nChr-65:nChr>96&&nChr<123?nChr-71:nChr>47&&nChr<58?nChr+4:43===nChr?62:47===nChr?63:0}var Base64={};Base64.encode=function(input){for(var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;i<input.length;)chr1=input.charCodeAt(i++),chr2=input.charCodeAt(i++),chr3=input.charCodeAt(i++),enc1=chr1>>2,enc2=(3&chr1)<<4|chr2>>4,enc3=(15&chr2)<<2|chr3>>6,enc4=63&chr3,isNaN(chr2)?enc3=enc4=64:isNaN(chr3)&&(enc4=64),output=output+keyStr.charAt(enc1)+keyStr.charAt(enc2)+keyStr.charAt(enc3)+keyStr.charAt(enc4);return output},Base64.encodeFromUint8Array=function(input){for(var nMod3,sB64Enc="",nLen=input.length,nUint24=0,nIdx=0;nIdx<nLen;nIdx++)nMod3=nIdx%3,nIdx>0&&4*nIdx/3%76===0&&(sB64Enc+="\r\n"),nUint24|=input[nIdx]<<(16>>>nMod3&24),2!==nMod3&&input.length-nIdx!==1||(sB64Enc+=String.fromCharCode(uint6ToB64(nUint24>>>18&63),uint6ToB64(nUint24>>>12&63),uint6ToB64(nUint24>>>6&63),uint6ToB64(63&nUint24)),nUint24=0);return sB64Enc.replace(/A(?=A$|$)/g,"=")},Base64.decode=function(input){var chr1,chr2,chr3,enc1,enc2,enc3,enc4,output="",i=0;for(input=input.replace(/[^A-Za-z0-9\+\/\=]/g,"");i<input.length;)enc1=keyStr.indexOf(input.charAt(i++)),enc2=keyStr.indexOf(input.charAt(i++)),enc3=keyStr.indexOf(input.charAt(i++)),enc4=keyStr.indexOf(input.charAt(i++)),chr1=enc1<<2|enc2>>4,chr2=(15&enc2)<<4|enc3>>2,chr3=(3&enc3)<<6|enc4,output+=String.fromCharCode(chr1),64!=enc3&&(output+=String.fromCharCode(chr2)),64!=enc4&&(output+=String.fromCharCode(chr3));return output},Base64.decodeToUint8Array=function(input){for(var nMod3,nMod4,nBlocksSize=1,sB64Enc=input.replace(/[^A-Za-z0-9\+\/]/g,""),nInLen=sB64Enc.length,nOutLen=nBlocksSize?Math.ceil((3*nInLen+1>>2)/nBlocksSize)*nBlocksSize:3*nInLen+1>>2,taBytes=new Uint8Array(nOutLen),nUint24=0,nOutIdx=0,nInIdx=0;nInIdx<nInLen;nInIdx++)if(nMod4=3&nInIdx,nUint24|=b64ToUint6(sB64Enc.charCodeAt(nInIdx))<<18-6*nMod4,3===nMod4||nInLen-nInIdx===1){for(nMod3=0;nMod3<3&&nOutIdx<nOutLen;nMod3++,nOutIdx++)taBytes[nOutIdx]=nUint24>>>(16>>>nMod3&24)&255;nUint24=0}return taBytes};var keyStr="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=";return Base64}();var miapp;miapp||(miapp={}),miapp.BrowserCapabilities=function(navigator,window,document){function prefixStyle(style){return""===capacities.vendor?style:(style=style.charAt(0).toUpperCase()+style.substr(1),capacities.vendor+style)}for(var capacities={vendor:"",cssVendor:""},dummyStyle=document.createElement("div").style,vendors="t,webkitT,MozT,msT,OT".split(","),nbVendors=vendors.length,i=0;i<nbVendors;i++){var t=vendors[i]+"ransform";if(t in dummyStyle){capacities.vendor=vendors[i].substr(0,vendors[i].length-1),capacities.cssVendor="-"+capacities.vendor.toLowerCase()+"-";break}}return capacities.transform=prefixStyle("transform"),capacities.transitionProperty=prefixStyle("transitionProperty"),capacities.transitionDuration=prefixStyle("transitionDuration"),capacities.transformOrigin=prefixStyle("transformOrigin"),capacities.transitionTimingFunction=prefixStyle("transitionTimingFunction"),capacities.transitionDelay=prefixStyle("transitionDelay"),capacities.isAndroid=/android/gi.test(navigator.appVersion),capacities.isIDevice=/iphone|ipad/gi.test(navigator.appVersion),capacities.isTouchPad=/hp-tablet/gi.test(navigator.appVersion),capacities.isPhantom=/phantom/gi.test(navigator.userAgent),capacities.hasTouch=("ontouchstart"in window||"createTouch"in document)&&(capacities.isAndroid||capacities.isIDevice)&&!capacities.isPhantom,capacities.has3d=prefixStyle("perspective")in dummyStyle,capacities.hasTransform=""!=capacities.vendor,capacities.hasTransitionEnd=prefixStyle("transition")in dummyStyle,capacities.online=navigator.onLine,capacities.RESIZE_EVENT="onorientationchange"in window?"orientationchange":"resize",capacities.TRNEND_EVENT=function(){if(""==capacities.vendor)return!1;var transitionEnd={"":"transitionend",webkit:"webkitTransitionEnd",Moz:"transitionend",O:"otransitionend",ms:"MSTransitionEnd"};return transitionEnd[capacities.vendor]}(),window.requestAnimationFrame?capacities.nextFrame=function(callback){return window.requestAnimationFrame(callback)}:window.webkitRequestAnimationFrame?capacities.nextFrame=function(callback){return window.webkitRequestAnimationFrame(callback)}:window.mozRequestAnimationFrame?capacities.nextFrame=function(callback){return window.mozRequestAnimationFrame(callback)}:window.oRequestAnimationFrame?capacities.nextFrame=function(callback){return window.oRequestAnimationFrame(callback)}:window.msRequestAnimationFrame?capacities.nextFrame=function(callback){return window.msRequestAnimationFrame(callback)}:capacities.nextFrame=function(callback){return setTimeout(callback,1)},window.cancelRequestAnimationFrame?capacities.cancelFrame=function(handle){
return window.cancelRequestAnimationFrame(handle)}:window.webkitCancelAnimationFrame?capacities.cancelFrame=function(handle){return window.webkitCancelAnimationFrame(handle)}:window.webkitCancelRequestAnimationFrame?capacities.cancelFrame=function(handle){return window.webkitCancelRequestAnimationFrame(handle)}:window.mozCancelRequestAnimationFrame?capacities.cancelFrame=function(handle){return window.mozCancelRequestAnimationFrame(handle)}:window.oCancelRequestAnimationFrame?capacities.cancelFrame=function(handle){return window.oCancelRequestAnimationFrame(handle)}:window.msCancelRequestAnimationFrame?capacities.cancelFrame=function(handle){return window.msCancelRequestAnimationFrame(handle)}:capacities.cancelFrame=function(handle){return clearTimeout(handle)},capacities.translateZ=capacities.has3d&&!capacities.isAndroid?" translateZ(0)":"",dummyStyle=null,capacities}(navigator,window,document);var miapp;miapp||(miapp={}),miapp.Json=function($){"use strict";function Json(){this.version="0.1"}if(!Object.toJSON&&!window.JSON)throw new Error("Object.toJSON or window.JSON needs to be loaded before miapp.Json!");return Json.uriEncode=function(obj){var name,value,fullSubName,subName,subValue,innerObj,i,query="";for(name in obj)if(obj.hasOwnProperty(name))if(value=obj[name],value instanceof Array)for(i=0;i<value.length;++i)subValue=value[i],fullSubName=name+"["+i+"]",innerObj={},innerObj[fullSubName]=subValue,query+=Json.uriEncode(innerObj)+"&";else if(value instanceof Object)for(subName in value)value.hasOwnProperty(subName)&&(subValue=value[subName],fullSubName=name+"["+subName+"]",innerObj={},innerObj[fullSubName]=subValue,query+=Json.uriEncode(innerObj)+"&");else void 0!==value&&null!==value&&(query+=encodeURIComponent(name)+"="+encodeURIComponent(value)+"&");return query.length?query.substr(0,query.length-1):query},Json.object2String=Object.toJSON||window.JSON&&(JSON.encode||JSON.stringify),Json.string2Object=window.JSON&&(JSON.decode||JSON.parse)||function(str){return String(str).evalJSON()},Json}(window.$||window.jQuery);var miapp;miapp||(miapp={}),miapp.formatError=function(arg){return arg instanceof Error&&(arg.stack?arg=arg.message&&arg.stack.indexOf(arg.message)===-1?"Error: "+arg.message+"\n"+arg.stack:arg.stack:arg.sourceURL&&(arg=arg.message+"\n"+arg.sourceURL+":"+arg.line)),arg},miapp.Log=function(){function Log(nbMax){this.nbMax=nbMax||1e3,this.nbMax<1&&(this.nbMax=1),this.logEntries=[],this.callbackHandle=0,this.callbacks=[]}return Log.prototype.getLog=function(){return this.logEntries},Log.prototype.clearLog=function(){this.logEntries=[]},Log.prototype.setNbMax=function(nbMax){this.nbMax=nbMax||1e3,this.nbMax<1&&(this.nbMax=1),this.logEntries.length>this.nbMax&&this.logEntries.splice(0,this.logEntries.length-this.nbMax)},Log.prototype.log=function(msg,details,traceStackOffset){details=details||"";var now=new Date;now=miappDateFormat(now)+"."+now.getMilliseconds();var stack,from="";if(traceStackOffset=traceStackOffset||0,stack=(new Error).stack){var caller_stack=stack.split("\n"),caller_line=caller_stack[2+traceStackOffset];if(caller_line){var index=caller_line.indexOf("at ")+3;from=" at "+caller_line.substr(index)}}var logEntry={date:now,msg:msg,details:details};this.logEntries.length>=this.nbMax&&this.logEntries.splice(0,1),this.logEntries.push(logEntry);for(var idx=0,nb=this.callbacks.length;idx<nb;idx++)try{this.callbacks[idx].callback(this.callbacks[idx].id,logEntry)}catch(e){}return logEntry},Log.prototype.addListener=function(fct){return this.callbackHandle++,this.callbacks.push({id:this.callbackHandle,callback:fct}),this.callbackHandle},Log.prototype.cancelListener=function(callbackHandle){for(var idx=this.callbacks.length-1;idx>=0;idx--)if(this.callbacks[idx].id==callbackHandle)return this.callbacks.splice(idx,1),!0;return!1},Log}(),miapp.ErrorLog=new miapp.Log(1e3),miapp.InternalLog=new miapp.Log(1e3);var miapp;miapp||(miapp={}),miapp.Sha1=function(){"use strict";function rstr2binb(input){for(var output=new Array(input.length>>2),i=0;i<output.length;i++)output[i]=0;for(var j=0;j<8*input.length;j+=8)output[j>>5]|=(255&input.charCodeAt(j/8))<<24-j%32;return output}function binb2rstr(input){for(var output="",i=0;i<32*input.length;i+=8)output+=String.fromCharCode(input[i>>5]>>>24-i%32&255);return output}function binb_sha1(x,len){x[len>>5]|=128<<24-len%32,x[(len+64>>9<<4)+15]=len;for(var w=new Array(80),a=1732584193,b=-271733879,c=-1732584194,d=271733878,e=-1009589776,i=0;i<x.length;i+=16){for(var olda=a,oldb=b,oldc=c,oldd=d,olde=e,j=0;j<80;j++){j<16?w[j]=x[i+j]:w[j]=bit_rol(w[j-3]^w[j-8]^w[j-14]^w[j-16],1);var t=safe_add(safe_add(bit_rol(a,5),sha1_ft(j,b,c,d)),safe_add(safe_add(e,w[j]),sha1_kt(j)));e=d,d=c,c=bit_rol(b,30),b=a,a=t}a=safe_add(a,olda),b=safe_add(b,oldb),c=safe_add(c,oldc),d=safe_add(d,oldd),e=safe_add(e,olde)}return[a,b,c,d,e]}function sha1_ft(t,b,c,d){return t<20?b&c|~b&d:t<40?b^c^d:t<60?b&c|b&d|c&d:b^c^d}function sha1_kt(t){return t<20?1518500249:t<40?1859775393:t<60?-1894007588:-899497514}function safe_add(x,y){var lsw=(65535&x)+(65535&y),msw=(x>>16)+(y>>16)+(lsw>>16);return msw<<16|65535&lsw}function bit_rol(num,cnt){return num<<cnt|num>>>32-cnt}var Sha1={};return Sha1.hash=function(input){var s=miapp.Utf8.encode(input);return binb2rstr(binb_sha1(rstr2binb(s),8*s.length))},Sha1.key256=function(password){var nBytes=32,halfLen=password.length/2,hash1=miapp.Sha1.hash(password.substr(0,halfLen)),hash2=miapp.Sha1.hash(password.substr(halfLen));return hash1.substr(0,16)+hash2.substr(0,nBytes-16)},Sha1}();var miapp;miapp||(miapp={}),miapp.MemoryStorage=function(){"use strict";function Storage(){this.keyes=[],this.set={},this.length=0}return Storage.prototype.clear=function(){this.keyes=[],this.set={},this.length=0},Storage.prototype.key=function(idx){return this.keyes[idx]},Storage.prototype.getItem=function(key){return miapp.isUndefined(this.set[key])?null:this.set[key]},Storage.prototype.setItem=function(key,value){this.set[key]=value;for(var i=0;i<this.keyes.length;i++)if(this.keyes[i]==key)return;this.keyes.push(key),this.length=this.keyes.length},Storage.prototype.removeItem=function(key){delete this.set[key];for(var i=0;i<this.keyes.length;i++)this.keyes[i]==key&&(this.keyes.splice(i,1),this.length=this.keyes.length)},Storage}(),miapp.LocalStorageFactory=function(storageService){"use strict";function LocalStorage(){if(this.version="0.1",!miapp.Xml)throw new Error("miapp.Xml needs to be loaded before miapp.LocalStorage!");if(!miapp.Json)throw new Error("miapp.Json needs to be loaded before miapp.LocalStorage!");if(!miapp.Xml.isXml||!miapp.Xml.xml2String||!miapp.Xml.string2Xml)throw new Error("miapp.Xml with isXml(), xml2String() and string2Xml() needs to be loaded before miapp.LocalStorage!");if(!miapp.Json.object2String||!miapp.Json.string2Object)throw new Error("miapp.Json with object2String() and string2Object() needs to be loaded before miapp.LocalStorage!")}function checkKey(key){if(!key||"string"!=typeof key)throw new TypeError("Key type must be string");return!0}var storage=storageService||window.localStorage;if(!storage)throw new Error("miapp.LocalStorageFactory needs a storageService!");return LocalStorage.prototype.set=function(key,value){checkKey(key);var t=typeof value;if("undefined"==t)value="null";else if(null===value)value="null";else if(miapp.Xml.isXml(value))value=miapp.Json.object2String({xml:miapp.Xml.xml2String(value)});else if("string"==t)value=miapp.Json.object2String({string:value});else if("number"==t)value=miapp.Json.object2String({number:value});else if("boolean"==t)value=miapp.Json.object2String({bool:value});else{if("object"!=t)throw new TypeError("Value type "+t+" is invalid. It must be null, undefined, xml, string, number, boolean or object");value=miapp.Json.object2String({json:value})}return storage.setItem(key,value),value},LocalStorage.prototype.get=function(key,def){checkKey(key);var item=storage.getItem(key);if(null!==item){if("null"==item)return null;var value=miapp.Json.string2Object(item);return"xml"in value?miapp.Xml.string2Xml(value.xml):"string"in value?value.string:"number"in value?value.number.valueOf():"bool"in value?value.bool.valueOf():value.json}return miapp.isUndefined(def)?null:def},LocalStorage.prototype.remove=function(key){checkKey(key);var existed=null!==storage.getItem(key);return storage.removeItem(key),existed},LocalStorage.prototype.clear=function(){var existed=storage.length>0;return storage.clear(),existed},LocalStorage.prototype.size=function(){return storage.length},LocalStorage.prototype.foreach=function(f,context){for(var n=storage.length,i=0;i<n;i++){var key=storage.key(i),value=this.get(key);context?f.call(context,value):f(value)}return n},LocalStorage},miapp.FileStorage=function(){"use strict";function FileStorage($q,$rootScope){this.version="0.1",this.q=$q,this.rootScope=$rootScope,this.grantedBytes=0,this.fs=null,this.urlPrefix="",this.storageType=null,this.initDone=!1,this.initPromises=[],this.initTimer=null}function initEnd(self){miapp.safeApply(self.rootScope,function(){for(var i=0;i<self.initPromises.length;i++)self.initTrigger(self.initPromises[i]);self.initDone=!0,self.initPromises=[],self.initTimer=null})}function launchEnd(self){null===self.initTimer&&(self.initTimer=setTimeout(function(){initEnd(self)},100))}function tryQuota(self,grantBytes){try{var fctOnSuccess=function(fs){self.fs=fs,self.urlPrefix="";var pattern=/^(https?)_([^_]+)_(\d+):Persistent$/;if(pattern.test(fs.name)){var name=fs.name;name=name.replace(pattern,"$1://$2:$3"),name=name.replace(/^(.*):0$/,"$1"),self.urlPrefix="filesystem:"+name+"/persistent"}self.initTrigger=function(deferred){deferred.resolve()},launchEnd(self)},fctOnFailure=function(fileError){if(fileError.code==FileError.QUOTA_EXCEEDED_ERR)setTimeout(function(){tryQuota(self,grantBytes/2)},100);else{var message="requestFileSystem failure : "+errorMessage(fileError);self.initTrigger=function(deferred){deferred.reject(message)},launchEnd(self)}},requestFs=function(grantedBytes){try{miapp.isDefined(window.requestFileSystem)?window.requestFileSystem(self.storageType,grantedBytes,fctOnSuccess,fctOnFailure):window.webkitRequestFileSystem(self.storageType,grantedBytes,fctOnSuccess,fctOnFailure)}catch(e){var message=e.message;self.initTrigger=function(deferred){deferred.reject(message)},launchEnd(self)}};miapp.isDefined(window.webkitPersistentStorage)?miapp.isDefined(window.webkitPersistentStorage.requestQuota)?window.webkitPersistentStorage.requestQuota(grantBytes,function(grantedBytes){self.grantedBytes=grantedBytes,requestFs(grantedBytes)},function(fileError){if(fileError.code==FileError.QUOTA_EXCEEDED_ERR)setTimeout(function(){tryQuota(self,grantBytes/2)},100);else{var message="requestQuota failure : "+errorMessage(fileError);self.initTrigger=function(deferred){deferred.reject(message)},launchEnd(self)}}):requestFs(grantBytes):miapp.isDefined(navigator.webkitPersistentStorage)&&miapp.isDefined(navigator.webkitPersistentStorage.requestQuota)?navigator.webkitPersistentStorage.requestQuota(self.storageType,grantBytes,function(grantedBytes){self.grantedBytes=grantedBytes,requestFs(grantedBytes)},function(fileError){if(fileError.code==FileError.QUOTA_EXCEEDED_ERR)setTimeout(function(){tryQuota(self,grantBytes/2)},100);else{var message="requestQuota failure : "+errorMessage(fileError);self.initTrigger=function(deferred){deferred.reject(message)},launchEnd(self)}}):requestFs(grantBytes)}catch(e){var message=e.message;self.initTrigger=function(deferred){deferred.reject(message)},launchEnd(self)}}function errorMessage(fileError){var msg="";switch(fileError.code){case FileError.NOT_FOUND_ERR:msg="File not found";break;case FileError.SECURITY_ERR:msg="Security error";break;case FileError.ABORT_ERR:msg="Aborted";break;case FileError.NOT_READABLE_ERR:msg="File not readable";break;case FileError.ENCODING_ERR:msg="Encoding error";break;case FileError.NO_MODIFICATION_ALLOWED_ERR:msg="File not modifiable";break;case FileError.INVALID_STATE_ERR:msg="Invalid state";break;case FileError.SYNTAX_ERR:msg="Syntax error";break;case FileError.INVALID_MODIFICATION_ERR:msg="Invalid modification";break;case FileError.QUOTA_EXCEEDED_ERR:msg="Quota exceeded";break;case FileError.TYPE_MISMATCH_ERR:msg="Type mismatch";break;case FileError.PATH_EXISTS_ERR:msg="File already exists";break;default:msg="Unknown FileError code (code= "+fileError.code+", type="+typeof fileError+")"}return msg}function getDirEntry(dirEntry,dirOptions,dirs,onSuccess,onFailure){if(dirs.length<=0)return void(onSuccess&&onSuccess(dirEntry));var bWillThrow=!1,dirName=dirs[0];dirs=dirs.slice(1),dirEntry.getDirectory(dirName,dirOptions,function(dirEntry){bWillThrow=!0,dirs.length?getDirEntry(dirEntry,dirOptions,dirs,onSuccess,onFailure):onSuccess&&onSuccess(dirEntry)},function(fileError){bWillThrow=!0,onFailure&&onFailure("getDirectory "+dirName+" from "+dirEntry.fullPath+" failure : "+errorMessage(fileError))})}function getFileEntry(rootEntry,filePath,fileOptions,onSuccess,onFailure){for(var names=filePath.split("/"),max=names.length-1,fileName=names[max],dirs=[],i=0;i<max;i++)"."!==names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions;dirOptions=fileOptions.create?{create:!0,exclusive:!1}:{create:!1,exclusive:!1},getDirEntry(rootEntry,dirOptions,dirs,function(dirEntry){dirEntry.getFile(fileName,fileOptions,function(fileEntry){onSuccess&&onSuccess(fileEntry)},function(fileError){onFailure&&onFailure("getFile "+fileName+" from "+dirEntry.fullPath+" failure : "+errorMessage(fileError))})},onFailure)}return FileStorage.prototype.init=function(){var deferred=this.q.defer();this.initPromises.push(deferred);var message;if(this.initDone)launchEnd(this);else if(1==this.initPromises.length)if(this.initPromises.push(deferred),miapp.isUndefinedOrNull(LocalFileSystem)?this.storageType=window.PERSISTENT:this.storageType=LocalFileSystem.PERSISTENT,window.File&&window.FileReader&&window.Blob)if(miapp.isUndefined(window.requestFileSystem)&&miapp.isUndefined(window.webkitRequestFileSystem))message="window.requestFileSystem() or window.webkitRequestFileSystem() required by miapp.FileStorage!",this.initTrigger=function(deferred){deferred.reject(message)},launchEnd(this);else if(miapp.isUndefined(window.resolveLocalFileSystemURL)&&miapp.isUndefined(window.webkitResolveLocalFileSystemURL)&&miapp.isUndefined(window.resolveLocalFileSystemURI)&&miapp.isUndefined(window.webkitResolveLocalFileSystemURI))message="window.resolveLocalFileSystemURI or equivalent required by miapp.FileStorage!",this.initTrigger=function(deferred){deferred.reject(message)},launchEnd(this);else{var grantBytes=4294967296,self=this;setTimeout(function(){tryQuota(self,grantBytes)},100)}else message="window.File, window.FileReader and window.Blob need to be loaded before miapp.FileStorage!",this.initTrigger=function(deferred){deferred.reject(message)},launchEnd(this);return deferred.promise},FileStorage.prototype.getFS=function(){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");return this.fs},FileStorage.prototype.createDir=function(dirPath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=dirPath.split("/"),max=names.length,dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!0,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){onSuccess&&onSuccess(dirEntry)},onFailure)},FileStorage.prototype.getDir=function(dirPath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=dirPath.split("/"),max=names.length,dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!1,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,onSuccess,onFailure)},FileStorage.prototype.readDirectory=function(dirPath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=dirPath.split("/"),max=names.length,dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!1,exclusive:!1},dirContentReader=function(dirEntry){var dirReader=dirEntry.createReader(),fileEntries=[],dirEntries=[],readEntries=function(){dirReader.readEntries(function(results){if(results.length){for(var max=results.length,i=0;i<max;i++)results[i].isFile?fileEntries.push(results[i].name):dirEntries.push(results[i].name);readEntries()}else onSuccess&&(dirEntries.sort(),fileEntries.sort(),onSuccess(dirEntries,fileEntries))},function(fileError){onFailure&&onFailure("readEntries from "+dirEntry.fullPath+" failure : "+errorMessage(fileError))})};readEntries()};getDirEntry(this.fs.root,dirOptions,dirs,dirContentReader,onFailure)},FileStorage.prototype.readFullDirectory=function(dirPath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=dirPath.split("/"),max=names.length,dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!1,exclusive:!1},dirEntries=[],fileEntries=[],dirContentReader=function(dirEntry){var dirReader=dirEntry.createReader(),readEntries=function(){dirReader.readEntries(function(results){if(results.length){for(var max=results.length,i=0;i<max;i++)results[i].isFile?fileEntries.push(results[i].fullPath):dirEntries.push(results[i]);readEntries()}else dirEntries.length<=0?onSuccess&&(fileEntries.sort(),onSuccess(fileEntries)):dirContentReader(dirEntries.shift())},function(fileError){onFailure&&onFailure("readEntries from "+dirEntry.fullPath+" failure : "+errorMessage(fileError))})};readEntries()};getDirEntry(this.fs.root,dirOptions,dirs,dirContentReader,onFailure)},FileStorage.prototype.deleteDir=function(dirPath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=dirPath.split("/"),max=names.length,dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!1,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){dirEntry.remove(function(){onSuccess&&onSuccess()},function(fileError){onFailure&&onFailure("remove "+dirEntry.fullPath+" failure : "+errorMessage(fileError))})},function(message){onSuccess&&onSuccess()})},FileStorage.prototype.deleteFullDir=function(dirPath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=dirPath.split("/"),max=names.length,dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!1,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){dirEntry.removeRecursively(function(){onSuccess&&onSuccess()},function(fileError){onFailure&&onFailure("removeRecursively "+dirEntry.fullPath+" failure : "+errorMessage(fileError))})},function(message){onSuccess&&onSuccess()})},FileStorage.prototype.getFileFromUrl=function(fileUrl,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");fileUrl=fileUrl.replace("/private/","/"),fileUrl=fileUrl.replace("/localhost/","/"),miapp.isDefined(window.resolveLocalFileSystemURL)?window.resolveLocalFileSystemURL(fileUrl,function(fileEntry){onSuccess&&onSuccess(fileEntry)},function(fileError){onFailure&&onFailure("resolveLocalFileSystemURL "+fileUrl+" failure : "+errorMessage(fileError))}):miapp.isDefined(window.webkitResolveLocalFileSystemURL)?window.webkitResolveLocalFileSystemURL(fileUrl,function(fileEntry){onSuccess&&onSuccess(fileEntry)},function(fileError){onFailure&&onFailure("webkitResolveLocalFileSystemURL "+fileUrl+" failure : "+errorMessage(fileError))}):this.getFileFromUri(fileUrl,onSuccess,onFailure)},FileStorage.prototype.getFileFromUri=function(fileUri,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");fileUri=fileUri.replace("/private/","/"),fileUri=fileUri.replace("/localhost/","/"),miapp.isDefined(window.resolveLocalFileSystemURI)?window.resolveLocalFileSystemURI(fileUri,function(fileEntry){onSuccess&&onSuccess(fileEntry)},function(fileError){onFailure&&onFailure("resolveLocalFileSystemURI "+fileUri+" failure : "+errorMessage(fileError))}):miapp.isDefined(window.webkitResolveLocalFileSystemURI)?window.webkitResolveLocalFileSystemURI(fileUri,function(fileEntry){onSuccess&&onSuccess(fileEntry)},function(fileError){onFailure&&onFailure("webkitResolveLocalFileSystemURI "+fileUri+" failure : "+errorMessage(fileError))}):this.getFileFromUrl(self.urlPrefix+fileUri,onSuccess,onFailure)},FileStorage.prototype.getUrlFromFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){miapp.isDefined(fileEntry.toNativeURL)?onSuccess&&onSuccess(fileEntry.toNativeURL()):onSuccess&&onSuccess(fileEntry.toURL())},onFailure)},FileStorage.prototype.getUriFromFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){onSuccess&&onSuccess(fileEntry.toURI())},onFailure)},FileStorage.prototype.getModificationTimeFromFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.getMetadata(function(metadata){onSuccess&&onSuccess(metadata.modificationTime)},function(fileError){onFailure&&onFailure("getMetadata "+fileEntry.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.getFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},onSuccess,onFailure)},FileStorage.prototype.newFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!0,exclusive:!0},onSuccess,onFailure)},FileStorage.prototype.getOrNewFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!0,exclusive:!1},onSuccess,onFailure)},FileStorage.prototype.readFileAsDataURL=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader;onSuccess&&(reader.onload=function(evt){onSuccess(evt.target.result)}),onFailure&&(reader.onerror=function(fileError){onFailure("readAsDataURL "+file.fullPath+" failure : "+errorMessage(fileError))}),reader.readAsDataURL(file)},function(fileError){onFailure&&onFailure("file "+file.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.readFileAsText=function(filePath,onSuccess,onFailure,onProgress,from,length){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader;onSuccess&&(reader.onload=function(evt){onSuccess(evt.target.result)}),onFailure&&(reader.onerror=function(fileError){onFailure("readAsText "+file.fullPath+" failure : "+errorMessage(fileError))}),reader.readAsText(file)},function(fileError){onFailure&&onFailure("file "+file.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.readFileAsArrayBuffer=function(filePath,onSuccess,onFailure,onProgress,from,length){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader;onSuccess&&(reader.onload=function(evt){onSuccess(evt.target.result)}),onFailure&&(reader.onerror=function(fileError){onFailure("readAsText "+file.fullPath+" failure : "+errorMessage(fileError))}),reader.readAsArrayBuffer(file)},function(fileError){onFailure&&onFailure("file "+file.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.readFileAsBinaryString=function(filePath,onSuccess,onFailure,onProgress,from,length){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.file(function(file){var reader=new FileReader;onSuccess&&(reader.onload=function(evt){onSuccess(evt.target.result)}),onFailure&&(reader.onerror=function(fileError){onFailure("readAsText "+file.fullPath+" failure : "+errorMessage(fileError))}),reader.readAsBinaryString(file)},function(fileError){onFailure&&onFailure("file "+file.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.writeFile=function(fromBlob,toFilePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,toFilePath,{create:!0,exclusive:!1},function(fileEntry){fileEntry.createWriter(function(fileWriter){fileWriter.onwriteend=function(evt){fileWriter.onwriteend=null,onSuccess&&(fileWriter.onwrite=function(evt){onSuccess(fileEntry)}),onFailure&&(fileWriter.onerror=function(fileError){onFailure("write or truncate "+fileEntry.fullPath+" failure : "+errorMessage(fileError))}),fileWriter.write(fromBlob)},fileWriter.truncate(0)},function(fileError){onFailure&&onFailure("createWriter "+fileEntry.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.appendFile=function(fromBlob,toFilePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,toFilePath,{create:!0,exclusive:!1},function(fileEntry){fileEntry.createWriter(function(fileWriter){onSuccess&&(fileWriter.onwrite=function(e){onSuccess(fileEntry)}),onFailure&&(fileWriter.onerror=function(fileError){onFailure("write or seek "+fileEntry.fullPath+" failure : "+errorMessage(fileError))}),fileWriter.seek(fileWriter.length),fileWriter.write(fromBlob)},function(fileError){onFailure&&onFailure("createWriter "+fileEntry.fullPath+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage.prototype.deleteFile=function(filePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");getFileEntry(this.fs.root,filePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.remove(function(){onSuccess&&onSuccess()},function(fileError){onFailure&&onFailure("remove "+fileEntry.fullPath+" failure : "+errorMessage(fileError))})},function(message){onSuccess&&onSuccess()})},FileStorage.prototype.copyFile=function(fromFilePath,toFilePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var self=this,names=toFilePath.split("/"),max=names.length-1,fileName=names[max],dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!0,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){getFileEntry(self.fs.root,fromFilePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.copyTo(dirEntry,fileName,function(toFileEntry){onSuccess&&onSuccess(toFileEntry)},function(fileError){onFailure&&onFailure("copy "+fileEntry.fullPath+" to "+dirEntry.fullPath+"/"+fileName+" failure : "+errorMessage(fileError))})},onFailure)},onFailure)},FileStorage.prototype.copyFileFromUrl=function(fromFileUrl,toFilePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var self=this,names=toFilePath.split("/"),max=names.length-1,fileName=names[max],dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!0,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){self.getFileFromUrl(fromFileUrl,function(fileEntry){fileEntry.copyTo(dirEntry,fileName,function(toFileEntry){onSuccess&&onSuccess(toFileEntry)},function(fileError){onFailure&&onFailure("copy "+fileEntry.fullPath+" to "+dirEntry.fullPath+"/"+fileName+" failure : "+errorMessage(fileError))})},onFailure)},onFailure)},FileStorage.prototype.moveFile=function(fromFilePath,toFilePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var self=this,names=toFilePath.split("/"),max=names.length-1,fileName=names[max],dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!0,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){getFileEntry(self.fs.root,fromFilePath,{create:!1,exclusive:!1},function(fileEntry){fileEntry.moveTo(dirEntry,fileName,function(toFileEntry){onSuccess&&onSuccess(toFileEntry)},function(fileError){onFailure&&onFailure("move "+fileEntry.fullPath+" to "+dirEntry.fullPath+"/"+fileName+" failure : "+errorMessage(fileError))})},onFailure)},onFailure)},FileStorage.prototype.moveFileEntry=function(fromFileEntry,toFilePath,onSuccess,onFailure){if(!this.fs)throw new Error("miapp.FileStorage is not yet initialized with its file system.");for(var names=toFilePath.split("/"),max=names.length-1,fileName=names[max],dirs=[],i=0;i<max;i++)"."!=names[i]&&""!==names[i]&&dirs.push(names[i]);var dirOptions={create:!0,exclusive:!1};getDirEntry(this.fs.root,dirOptions,dirs,function(dirEntry){fromFileEntry.moveTo(dirEntry,fileName,function(toFileEntry){onSuccess&&onSuccess(toFileEntry)},function(fileError){onFailure&&onFailure("move "+fileEntry.fullPath+" to "+dirEntry.fullPath+"/"+fileName+" failure : "+errorMessage(fileError))})},onFailure)},FileStorage}(),miapp.PredefinedFileStorage=function(){function PredefinedFileStorage(fileSystem,grantedBytes){this.version="0.1",this.fs=fileSystem,this.grantedBytes=grantedBytes}return PredefinedFileStorage.prototype=miapp.FileStorage.prototype,PredefinedFileStorage}();var miapp;miapp||(miapp={}),"undefined"!=typeof angular&&angular.module("miapp.services",[]).factory("srvLocalStorage",function(){var LocalStorage=miapp.LocalStorageFactory(window.localStorage);return new LocalStorage});var miapp;miapp||(miapp={}),miapp.Utf8=function(){"use strict";var Utf8={};return Utf8.encode=function(input){for(var nChr,utftext="",nStrLen=input.length,nChrIdx=0;nChrIdx<nStrLen;nChrIdx++)nChr=input.charCodeAt(nChrIdx),nChr<128?utftext+=String.fromCharCode(nChr):nChr<2048?(utftext+=String.fromCharCode(192+(nChr>>>6)),utftext+=String.fromCharCode(128+(63&nChr))):nChr<65536?(utftext+=String.fromCharCode(224+(nChr>>>12)),utftext+=String.fromCharCode(128+(nChr>>>6&63)),utftext+=String.fromCharCode(128+(63&nChr))):nChr<2097152?(utftext+=String.fromCharCode(240+(nChr>>>18)),utftext+=String.fromCharCode(128+(nChr>>>12&63)),utftext+=String.fromCharCode(128+(nChr>>>6&63)),utftext+=String.fromCharCode(128+(63&nChr))):nChr<67108864?(utftext+=String.fromCharCode(248+(nChr>>>24)),utftext+=String.fromCharCode(128+(nChr>>>18&63)),utftext+=String.fromCharCode(128+(nChr>>>12&63)),utftext+=String.fromCharCode(128+(nChr>>>6&63)),utftext+=String.fromCharCode(128+(63&nChr))):(utftext+=String.fromCharCode(252+nChr/1073741824),utftext+=String.fromCharCode(128+(nChr>>>24&63)),utftext+=String.fromCharCode(128+(nChr>>>18&63)),utftext+=String.fromCharCode(128+(nChr>>>12&63)),utftext+=String.fromCharCode(128+(nChr>>>6&63)),utftext+=String.fromCharCode(128+(63&nChr)));return utftext;
},Utf8.encodeToUint8Array=function(input){for(var aBytes,nChr,nStrLen=input.length,nArrLen=0,nMapIdx=0;nMapIdx<nStrLen;nMapIdx++)nChr=input.charCodeAt(nMapIdx),nArrLen+=nChr<128?1:nChr<2048?2:nChr<65536?3:nChr<2097152?4:nChr<67108864?5:6;aBytes=new Uint8Array(nArrLen);for(var nIdx=0,nChrIdx=0;nIdx<nArrLen;nChrIdx++)nChr=input.charCodeAt(nChrIdx),nChr<128?aBytes[nIdx++]=nChr:nChr<2048?(aBytes[nIdx++]=192+(nChr>>>6),aBytes[nIdx++]=128+(63&nChr)):nChr<65536?(aBytes[nIdx++]=224+(nChr>>>12),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr)):nChr<2097152?(aBytes[nIdx++]=240+(nChr>>>18),aBytes[nIdx++]=128+(nChr>>>12&63),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr)):nChr<67108864?(aBytes[nIdx++]=248+(nChr>>>24),aBytes[nIdx++]=128+(nChr>>>18&63),aBytes[nIdx++]=128+(nChr>>>12&63),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr)):(aBytes[nIdx++]=252+nChr/1073741824,aBytes[nIdx++]=128+(nChr>>>24&63),aBytes[nIdx++]=128+(nChr>>>18&63),aBytes[nIdx++]=128+(nChr>>>12&63),aBytes[nIdx++]=128+(nChr>>>6&63),aBytes[nIdx++]=128+(63&nChr));return aBytes},Utf8.decode=function(input){for(var nChr,nCode,sView="",nStrLen=input.length,nChrIdx=0;nChrIdx<nStrLen;nChrIdx++)nChr=input.charCodeAt(nChrIdx),nChr>=252&&nChr<=253&&nChrIdx+5<nStrLen?(nCode=1073741824*(1&nChr),nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<24,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<18,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<12,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<6,nChr=input.charCodeAt(++nChrIdx),nCode|=63&nChr,sView+=String.fromCharCode(nCode)):nChr>=248&&nChr<=251&&nChrIdx+4<nStrLen?(nCode=(3&nChr)<<24,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<18,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<12,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<6,nChr=input.charCodeAt(++nChrIdx),nCode|=63&nChr,sView+=String.fromCharCode(nCode)):nChr>=240&&nChr<=247&&nChrIdx+3<nStrLen?(nCode=(7&nChr)<<18,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<12,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<6,nChr=input.charCodeAt(++nChrIdx),nCode|=63&nChr,sView+=String.fromCharCode(nCode)):nChr>=224&&nChr<=239&&nChrIdx+2<nStrLen?(nCode=(15&nChr)<<12,nChr=input.charCodeAt(++nChrIdx),nCode|=(63&nChr)<<6,nChr=input.charCodeAt(++nChrIdx),nCode|=63&nChr,sView+=String.fromCharCode(nCode)):nChr>=192&&nChr<=223&&nChrIdx+1<nStrLen?(nCode=(31&nChr)<<6,nChr=input.charCodeAt(++nChrIdx),nCode|=63&nChr,sView+=String.fromCharCode(nCode)):sView+=String.fromCharCode(127&nChr);return sView},Utf8.decodeFromUint8Array=function(aBytes){for(var nPart,nCode,sView="",nLen=aBytes.length,nIdx=0;nIdx<nLen;nIdx++)nPart=aBytes[nIdx],nPart>=252&&nPart<=253&&nIdx+5<nLen?(nCode=1073741824*(1&nPart),nPart=aBytes[++nIdx],nCode+=(63&nPart)<<24,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<18,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<12,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<6,nPart=aBytes[++nIdx],nCode+=63&nPart,sView+=String.fromCharCode(nCode)):nPart>=248&&nPart<=251&&nIdx+4<nLen?(nCode=(3&nPart)<<24,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<18,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<12,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<6,nPart=aBytes[++nIdx],nCode+=63&nPart,sView+=String.fromCharCode(nCode)):nPart>=240&&nPart<=247&&nIdx+3<nLen?(nCode=(7&nPart)<<18,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<12,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<6,nPart=aBytes[++nIdx],nCode+=63&nPart,sView+=String.fromCharCode(nCode)):nPart>=224&&nPart<=239&&nIdx+2<nLen?(nCode=(15&nPart)<<12,nPart=aBytes[++nIdx],nCode+=(63&nPart)<<6,nPart=aBytes[++nIdx],nCode+=63&nPart,sView+=String.fromCharCode(nCode)):nPart>=192&&nPart<=223&&nIdx+1<nLen?(nCode=(31&nPart)<<6,nPart=aBytes[++nIdx],nCode+=63&nPart,sView+=String.fromCharCode(nCode)):sView+=String.fromCharCode(127&nPart);return sView},Utf8}();var miapp;miapp||(miapp={}),miapp.Xml=function(){function Xml(){this.version="0.1"}Xml.isXml=function(elm){var documentElement=(elm?elm.ownerDocument||elm:0).documentElement;return!!documentElement&&"HTML"!==documentElement.nodeName},Xml.xml2String=function(xmlNode){if(!Xml.isXml(xmlNode))return!1;try{return(new XMLSerializer).serializeToString(xmlNode)}catch(E1){try{return xmlNode.xml}catch(E2){}}return!1},Xml.string2Xml=function(xmlString){if(!dom_parser)return!1;var resultXML=dom_parser.call("DOMParser"in window&&new DOMParser||window,xmlString,"text/xml");return!!this.isXml(resultXML)&&resultXML};var dom_parser="DOMParser"in window&&(new DOMParser).parseFromString||window.ActiveXObject&&function(_xmlString){var xml_doc=new ActiveXObject("Microsoft.XMLDOM");return xml_doc.async="false",xml_doc.loadXML(_xmlString),xml_doc};return Xml}(),"undefined"!=typeof angular&&angular.module("MiappService",[]).factory("MiappService",function($log,$q){return new MiappService($log,$q)});var MiappService=function(){"use strict";function Service($log,$q){this.logger=$log,this.promise=$q,this.miappService=null}return Service.prototype.init=function(miappId,miappSalt,isOffline){return this.miappService?this.promise.reject("miapp.sdk.angular.init : already initialized."):(this.miappService=new SrvMiapp(this.logger,this.promise),this.miappService.init(miappId,miappSalt,isOffline))},Service.prototype.login=function(login,password){return this.miappService?this.miappService.initDBWithLogin(login,password):this.promise.reject("miapp.sdk.angular.login : not initialized.")},Service.prototype.sync=function(fnInitFirstData){return this.miappService?this.miappService.syncComplete(fnInitFirstData,this):this.promise.reject("miapp.sdk.angular.sync : not initialized.")},Service.prototype.put=function(data){return this.miappService?this.miappService.putInDb(data):this.promise.reject("miapp.sdk.angular.put : not initialized.")},Service.prototype.find=function(id){return this.miappService?this.miappService.findInDb(id):this.promise.reject("miapp.sdk.angular.find : not initialized.")},Service.prototype.findAll=function(){return this.miappService?this.miappService.findAllInDb():this.promise.reject("miapp.sdk.angular.findAll : not initialized.")},Service.prototype._testPromise=function(){return this.miappService?this.miappService._testPromise():this.promise.reject("miapp.sdk.angular.testPromise : not initialized.")},Service}(),MiappEventable=function(){throw Error("'MiappEventable' is not intended to be invoked directly")};MiappEventable.prototype={bind:function(event,fn){this._events=this._events||{},this._events[event]=this._events[event]||[],this._events[event].push(fn)},unbind:function(event,fn){this._events=this._events||{},event in this._events!=!1&&this._events[event].splice(this._events[event].indexOf(fn),1)},trigger:function(event){if(this._events=this._events||{},event in this._events!=!1)for(var i=0;i<this._events[event].length;i++)this._events[event][i].apply(this,Array.prototype.slice.call(arguments,1))}},MiappEventable.mixin=function(destObject){for(var props=["bind","unbind","trigger"],i=0;i<props.length;i++)props[i]in destObject.prototype&&(destObject.prototype["_"+props[i]]=destObject.prototype[props[i]]),destObject.prototype[props[i]]=MiappEventable.prototype[props[i]]},function(global){function Logger(name){this.logEnabled=!0,this.init(name,!0)}var name="Logger",overwrittenName=global[name];return Logger.METHODS=["log","error","warn","info","debug","assert","clear","count","dir","dirxml","exception","group","groupCollapsed","groupEnd","profile","profileEnd","table","time","timeEnd","trace"],Logger.prototype.init=function(name,logEnabled){this.name=name||"UNKNOWN",this.logEnabled=logEnabled||!0;var addMethod=function(method){this[method]=this.createLogMethod(method)}.bind(this);Logger.METHODS.forEach(addMethod)},Logger.prototype.createLogMethod=function(method){return Logger.prototype.log.bind(this,method)},Logger.prototype.prefix=function(method,args){var prepend="["+method.toUpperCase()+"]["+name+"]:\t";return["log","error","warn","info"].indexOf(method)!==-1&&("string"==typeof args[0]?args[0]=prepend+args[0]:args.unshift(prepend)),args},Logger.prototype.log=function(){var args=[].slice.call(arguments),method=args.shift();Logger.METHODS.indexOf(method)===-1&&(method="log"),this.logEnabled&&console&&console[method]&&(args=this.prefix(method,args))},Logger.prototype.setLogEnabled=function(logEnabled){this.logEnabled=logEnabled||!0},Logger.mixin=function(destObject){destObject.__logger=new Logger(destObject.name||"UNKNOWN");var addMethod=function(method){method in destObject.prototype&&(destObject.prototype["_"+method]=destObject.prototype[method]),destObject.prototype[method]=destObject.__logger.createLogMethod(method)};Logger.METHODS.forEach(addMethod)},global[name]=Logger,global[name].noConflict=function(){return overwrittenName&&(global[name]=overwrittenName),Logger},global[name]}(this||window),function(global){function MiappPromise(){this.complete=!1,this.error=null,this.result=null,this.callbacks=[]}var name="MiappPromise",overwrittenName=global[name];return MiappPromise.prototype.then=function(callback,context){var f=function(){return callback.apply(context,arguments)};this.complete?f(this.error,this.result):this.callbacks.push(f)},MiappPromise.prototype.done=function(error,result){if(this.complete=!0,this.error=error,this.result=result,this.callbacks){for(var i=0;i<this.callbacks.length;i++)this.callbacks[i](error,result);this.callbacks.length=0}},MiappPromise.join=function(promises){function notifier(i){return function(error,result){completed+=1,errors[i]=error,results[i]=result,completed===total&&p.done(errors,results)}}for(var p=new MiappPromise,total=promises.length,completed=0,errors=[],results=[],i=0;i<total;i++)promises[i]().then(notifier(i));return p},MiappPromise.chain=function(promises,error,result){var p=new MiappPromise;return null===promises||0===promises.length?p.done(error,result):promises[0](error,result).then(function(res,err){promises.splice(0,1),promises?MiappPromise.chain(promises,res,err).then(function(r,e){p.done(r,e)}):p.done(res,err)}),p},global[name]=MiappPromise,global[name].noConflict=function(){return overwrittenName&&(global[name]=overwrittenName),MiappPromise},global[name]}(this||window),function(global){function partial(){var args=Array.prototype.slice.call(arguments),fn=args.shift();return fn.bind(this,args)}function Ajax(){function encode(data){var result="";if("string"==typeof data)result=data;else{var e=encodeURIComponent;for(var i in data)data.hasOwnProperty(i)&&(result+="&"+e(i)+"="+e(data[i]))}return result}function request(m,u,d,token){var timeout,p=new MiappPromise;return self.logger.time(m+" "+u),function(xhr){xhr.onreadystatechange=function(){4===this.readyState&&(self.logger.timeEnd(m+" "+u),clearTimeout(timeout),p.done(null,this))},xhr.onerror=function(response){clearTimeout(timeout),p.done(response,null)},xhr.oncomplete=function(response){clearTimeout(timeout),self.logger.timeEnd(m+" "+u),self.info("%s request to %s returned %s",m,u,this.status)},xhr.open(m,u),d&&("object"==typeof d&&(d=JSON.stringify(d)),xhr.setRequestHeader("Content-Type","application/json"),xhr.setRequestHeader("Accept","application/json")),timeout=setTimeout(function(){xhr.abort(),p.done("API Call timed out.",null)},3e4),xhr.send(encode(d))}(new XMLHttpRequest),p}this.logger=new global.Logger(name);var self=this;this.request=request,this.get=partial(request,"GET"),this.post=partial(request,"POST"),this.put=partial(request,"PUT"),this.delete=partial(request,"DELETE")}var exports,name="Ajax",overwrittenName=global[name];return global[name]=new Ajax,global[name].noConflict=function(){return overwrittenName&&(global[name]=overwrittenName),exports},global[name]}(this||window),window.console=window.console||{},window.console.log=window.console.log||function(){};var uuidValueRegex=/^[0-9a-fA-F]{8}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{4}-[0-9a-fA-F]{12}$/;!function(global){function Miapp(){this.logger=new Logger(name)}var name="Miapp",overwrittenName=global[name],VALID_REQUEST_METHODS=["GET","POST","PUT","DELETE"];return Miapp.isValidEndpoint=function(endpoint){return!0},Miapp.Request=function(method,endpoint,query_params,data,callback){var p=new MiappPromise;if(this.logger=new global.Logger("Miapp.Request"),this.logger.time("process request "+method+" "+endpoint),this.endpoint=endpoint+"?"+encodeParams(query_params),this.method=method.toUpperCase(),this.data="object"==typeof data?JSON.stringify(data):data,VALID_REQUEST_METHODS.indexOf(this.method)===-1)throw new MiappInvalidHTTPMethodError("invalid request method '"+this.method+"'");if(!isValidUrl(this.endpoint))throw this.logger.error(endpoint,this.endpoint,/^https:\/\//.test(endpoint)),new MiappInvalidURIError("The provided endpoint is not valid: "+this.endpoint);var token=null;query_params&&(token=query_params.access_token);var request=function(){return Ajax.request(this.method,this.endpoint,this.data,token)}.bind(this),response=function(err,request){return new Miapp.Response(err,request)}.bind(this),oncomplete=function(err,response){p.done(err,response),this.logger.info("REQUEST",err,response),doCallback(callback,[err,response]),this.logger.timeEnd("process request "+method+" "+endpoint)}.bind(this);return MiappPromise.chain([request,response]).then(oncomplete),p},Miapp.Response=function(err,response){var p=new MiappPromise,data=null;try{data=JSON.parse(response.responseText)}catch(e){data={}}switch(Object.keys(data).forEach(function(key){Object.defineProperty(this,key,{value:data[key],enumerable:!0})}.bind(this)),Object.defineProperty(this,"logger",{enumerable:!1,configurable:!1,writable:!1,value:new global.Logger(name)}),Object.defineProperty(this,"success",{enumerable:!1,configurable:!1,writable:!0,value:!0}),Object.defineProperty(this,"err",{enumerable:!1,configurable:!1,writable:!0,value:err}),Object.defineProperty(this,"status",{enumerable:!1,configurable:!1,writable:!0,value:parseInt(response.status)}),Object.defineProperty(this,"statusGroup",{enumerable:!1,configurable:!1,writable:!0,value:this.status-this.status%100}),this.statusGroup){case 200:this.success=!0;break;case 400:case 500:case 300:case 100:default:this.success=!1}return this.success?p.done(null,this):p.done(MiappError.fromResponse(data),this),p},Miapp.Response.prototype.getEntities=function(){var entities;return this.success&&(entities=this.data?this.data.entities:this.entities),entities||[]},Miapp.Response.prototype.getEntity=function(){var entities=this.getEntities();return entities[0]},Miapp.VERSION=Miapp.USERGRID_SDK_VERSION="0.11.0",global[name]=Miapp,global[name].noConflict=function(){return overwrittenName&&(global[name]=overwrittenName),Miapp},global[name]}(this||window),function(global){var exports,name="Client",overwrittenName=global[name];return Miapp.Client=function(options){this.URI=options.URI,options.orgName&&this.set("orgName",options.orgName),options.appName&&this.set("appName",options.appName),options.qs&&this.setObject("default_qs",options.qs),this.buildCurl=options.buildCurl||!1,this.logging=options.logging||!1},Miapp.Client.prototype.request=function(options,callback){var uri,method=options.method||"GET",endpoint=options.endpoint,body=options.body||{},qs=options.qs||{},mQuery=options.mQuery||!1,orgName=this.get("orgName"),appName=this.get("appName"),default_qs=this.getObject("default_qs");if(!mQuery&&!orgName&&!appName)return logoutCallback();uri=mQuery?this.URI+"/"+endpoint:this.URI+"/"+orgName+"/"+appName+"/"+endpoint,this.getToken()&&(qs.access_token=this.getToken()),default_qs&&(qs=propCopy(qs,default_qs));var self=this;new Miapp.Request(method,uri,qs,body,function(err,response){err?doCallback(callback,[err,response,self],self):doCallback(callback,[null,response,self],self)})},Miapp.Client.prototype.buildAssetURL=function(uuid){var self=this,qs={},assetURL=this.URI+"/"+this.orgName+"/"+this.appName+"/assets/"+uuid+"/data";self.getToken()&&(qs.access_token=self.getToken());var encoded_params=encodeParams(qs);return encoded_params&&(assetURL+="?"+encoded_params),assetURL},Miapp.Client.prototype.createGroup=function(options,callback){var group=new Miapp.Group({path:options.path,client:this,data:options});group.save(function(err,response){doCallback(callback,[err,response,group],group)})},Miapp.Client.prototype.createEntity=function(options,callback){var entity=new Miapp.Entity({client:this,data:options});entity.save(function(err,response){doCallback(callback,[err,response,entity],entity)})},Miapp.Client.prototype.getEntity=function(options,callback){var entity=new Miapp.Entity({client:this,data:options});entity.fetch(function(err,response){doCallback(callback,[err,response,entity],entity)})},Miapp.Client.prototype.restoreEntity=function(serializedObject){var data=JSON.parse(serializedObject),options={client:this,data:data},entity=new Miapp.Entity(options);return entity},Miapp.Client.prototype.createCounter=function(options,callback){var counter=new Miapp.Counter({client:this,data:options});counter.save(callback)},Miapp.Client.prototype.createAsset=function(options,callback){var file=options.file;file&&(options.name=options.name||file.name,options["content-type"]=options["content-type"]||file.type,options.path=options.path||"/",delete options.file);var asset=new Miapp.Asset({client:this,data:options});asset.save(function(err,response,asset){file&&!err?asset.upload(file,callback):doCallback(callback,[err,response,asset],asset)})},Miapp.Client.prototype.createCollection=function(options,callback){return options.client=this,new Miapp.Collection(options,function(err,data,collection){doCallback(callback,[err,collection,data])})},Miapp.Client.prototype.restoreCollection=function(serializedObject){var data=JSON.parse(serializedObject);data.client=this;var collection=new Miapp.Collection(data);return collection},Miapp.Client.prototype.getFeedForUser=function(username,callback){var options={method:"GET",endpoint:"users/"+username+"/feed"};this.request(options,function(err,data){err?doCallback(callback,[err]):doCallback(callback,[err,data,data.getEntities()])})},Miapp.Client.prototype.createUserActivity=function(user,options,callback){options.type="users/"+user+"/activities",options={client:this,data:options};var entity=new Miapp.Entity(options);entity.save(function(err,data){doCallback(callback,[err,data,entity])})},Miapp.Client.prototype.createUserActivityWithEntity=function(user,content,callback){var username=user.get("username"),options={actor:{displayName:username,uuid:user.get("uuid"),username:username,email:user.get("email"),picture:user.get("picture"),image:{duration:0,height:80,url:user.get("picture"),width:80}},verb:"post",content:content};this.createUserActivity(username,options,callback)},Miapp.Client.prototype.calcTimeDiff=function(){var seconds=0,time=this._end-this._start;try{seconds=(time/10/60).toFixed(2)}catch(e){return 0}return seconds},Miapp.Client.prototype.setToken=function(token){this.set("token",token)},Miapp.Client.prototype.setEndpoint=function(endpoint){this.set("endpoint",endpoint)},Miapp.Client.prototype.setUserId=function(userId){this.set("userid",userId)},Miapp.Client.prototype.setAppId=function(appId){this.set("miappid",appId)},Miapp.Client.prototype.getToken=function(){return this.get("token")},Miapp.Client.prototype.getEndpoint=function(){return this.get("endpoint")},Miapp.Client.prototype.getUserId=function(){return this.get("userid")},Miapp.Client.prototype.getAppId=function(){return this.get("miappid")},Miapp.Client.prototype.setObject=function(key,value){value&&(value=JSON.stringify(value)),this.set(key,value)},Miapp.Client.prototype.set=function(key,value){var keyStore="apigee_"+key;this[key]=value,"undefined"!=typeof Storage&&(value?localStorage.setItem(keyStore,value):localStorage.removeItem(keyStore))},Miapp.Client.prototype.getObject=function(key){return JSON.parse(this.get(key))},Miapp.Client.prototype.get=function(key){var keyStore="apigee_"+key,value=null;return this[key]?value=this[key]:"undefined"!=typeof Storage&&(value=localStorage.getItem(keyStore)),value},Miapp.Client.prototype.signup=function(username,password,email,name,callback){var options={type:"users",username:username,password:password,email:email,name:name};this.createEntity(options,callback)},Miapp.Client.prototype.login=function(username,password,callback){var self=this,options={method:"POST",endpoint:"token",body:{username:username,password:password,grant_type:"password"}};self.request(options,function(err,response){var user={};if(err)self.logging;else{var options={client:self,data:response.user};user=new Miapp.Entity(options),self.setToken(response.access_token)}doCallback(callback,[err,response,user])})},Miapp.Client.prototype.authMLE=function(callback){var self=this,userId=self.getUserId(),appId=self.getAppId(),options={method:"POST",mQuery:!0,endpoint:"auth",body:{userId:userId,appId:appId,userSrc:"miapp_fwk"}};self.request(options,function(err,response){var user={};if(err)self.logging;else{var options={client:self,data:{_id:userId}};user=new Miapp.Entity(options),self.setToken(response.authToken),self.setEndpoint(response.endpoint)}doCallback(callback,[err,response,user])})},Miapp.Client.prototype.loginMLE=function(appid,login,password,updateProperties,callback){var self=this;self.setAppId(appid);var options={method:"POST",mQuery:!0,endpoint:"users",body:{name:login,username:login,email:login,password:password,grant_type:"password"}};self.request(options,function(err,response){return self.setToken(password),self.setUserId(response._id),self.authMLE(callback)})},Miapp.Client.prototype.deleteUserMLE=function(userIDToDelete,callback){var self=this,options={method:"DELETE",mQuery:!0,endpoint:"users/"+userIDToDelete};self.request(options,function(err,response){err&&self.logging,doCallback(callback,[err,response])})},Miapp.Client.prototype.reAuthenticateLite=function(callback){var self=this,options={method:"GET",endpoint:"management/me",mQuery:!0};this.request(options,function(err,response){err&&self.logging||self.setToken(response.data.access_token),doCallback(callback,[err])})},Miapp.Client.prototype.reAuthenticate=function(email,callback){var self=this,options={method:"GET",endpoint:"management/users/"+email,mQuery:!0};this.request(options,function(err,response){var data,organizations={},applications={},user={};if(err&&self.logging);else{data=response.data,self.setToken(data.token),self.set("email",data.email),localStorage.setItem("accessToken",data.token),localStorage.setItem("userUUID",data.uuid),localStorage.setItem("userEmail",data.email);var userData={username:data.username,email:data.email,name:data.name,uuid:data.uuid},options={client:self,data:userData};user=new Miapp.Entity(options),organizations=data.organizations;var org="";try{var existingOrg=self.get("orgName");org=organizations[existingOrg]?organizations[existingOrg]:organizations[Object.keys(organizations)[0]],self.set("orgName",org.name)}catch(e){err=!0,self.logging}applications=self.parseApplicationsArray(org),self.selectFirstApp(applications),self.setObject("organizations",organizations),self.setObject("applications",applications)}doCallback(callback,[err,data,user,organizations,applications],self)})},Miapp.Client.prototype.loginFacebook=function(facebookToken,callback){var self=this,options={method:"GET",endpoint:"auth/facebook",qs:{fb_access_token:facebookToken}};this.request(options,function(err,data){var user={};if(err&&self.logging);else{var options={client:self,data:data.user};user=new Miapp.Entity(options),self.setToken(data.access_token)}doCallback(callback,[err,data,user],self)})},Miapp.Client.prototype.getLoggedInUser=function(callback){var self=this;if(this.getToken()){var options={method:"GET",endpoint:"users/me"};this.request(options,function(err,response){if(err)self.logging,doCallback(callback,[err,response,self],self);else{var options={client:self,data:response.getEntity()},user=new Miapp.Entity(options);doCallback(callback,[null,response,user],self)}})}else doCallback(callback,[new MiappError("Access Token not set"),null,self],self)},Miapp.Client.prototype.isLoggedIn=function(){var token=this.getToken();return"undefined"!=typeof token&&null!==token},Miapp.Client.prototype.logout=function(){this.setToken()},Miapp.Client.prototype.destroyToken=function(username,token,revokeAll,callback){var options={client:self,method:"PUT"};revokeAll===!0?options.endpoint="users/"+username+"/revoketokens":null===token?options.endpoint="users/"+username+"/revoketoken?token="+this.getToken():options.endpoint="users/"+username+"/revoketoken?token="+token,this.request(options,function(err,data){err?(self.logging,doCallback(callback,[err,data,null],self)):doCallback(callback,[err,data,null],self)})},Miapp.Client.prototype.logoutAndDestroyToken=function(username,token,revokeAll,callback){null===username||(this.destroyToken(username,token,revokeAll,callback),revokeAll!==!0&&token!==this.getToken()&&null!==token||this.setToken(null))},Miapp.Client.prototype.buildCurlCall=function(options){var curl=["curl"],method=(options.method||"GET").toUpperCase(),body=options.body,uri=options.uri;return curl.push("-X"),curl.push(["POST","PUT","DELETE"].indexOf(method)>=0?method:"GET"),curl.push(uri),"object"==typeof body&&Object.keys(body).length>0&&["POST","PUT"].indexOf(method)!==-1&&(curl.push("-d"),curl.push("'"+JSON.stringify(body)+"'")),curl=curl.join(" ")},Miapp.Client.prototype.getDisplayImage=function(email,picture,size){size=size||50;var image="https://apigee.com/miapp/images/user_profile.png";try{picture?image=picture:email.length&&(image="https://secure.gravatar.com/avatar/"+MD5(email)+"?s="+size+encodeURI("&d=https://apigee.com/miapp/images/user_profile.png"))}catch(e){}finally{return image}},global[name]=Miapp.Client,global[name].noConflict=function(){return overwrittenName&&(global[name]=overwrittenName),exports},global[name]}(this||window);var ENTITY_SYSTEM_PROPERTIES=["metadata","created","modified","oldpassword","newpassword","type","activated","uuid"];Miapp.Entity=function(options){this._data={},this._client=void 0,options&&(this.set(options.data||{}),this._client=options.client||{})},Miapp.Entity.isEntity=function(obj){return obj&&obj instanceof Miapp.Entity},Miapp.Entity.isPersistedEntity=function(obj){return isEntity(obj)&&isUUID(obj.get("uuid"))},Miapp.Entity.prototype.serialize=function(){return JSON.stringify(this._data)},Miapp.Entity.prototype.get=function(key){var value;if(0===arguments.length?value=this._data:arguments.length>1&&(key=[].slice.call(arguments).reduce(function(p,c,i,a){return c instanceof Array?p=p.concat(c):p.push(c),p},[])),key instanceof Array){var self=this;value=key.map(function(k){return self.get(k)})}else"undefined"!=typeof key&&(value=this._data[key]);return value},Miapp.Entity.prototype.set=function(key,value){if("object"==typeof key)for(var field in key)this._data[field]=key[field];else"string"==typeof key?null===value?delete this._data[key]:this._data[key]=value:this._data={}},Miapp.Entity.prototype.getEndpoint=function(){var name,type=this.get("type"),nameProperties=["uuid","name"];if(void 0===type)throw new MiappError("cannot fetch entity, no entity type specified","no_type_specified");return/^users?$/.test(type)&&nameProperties.unshift("username"),name=this.get(nameProperties).filter(function(x){return null!==x&&"undefined"!=typeof x}).shift(),name?[type,name].join("/"):type},Miapp.Entity.prototype.save=function(callback){var self=this,type=this.get("type"),method="POST",entityId=this.get("uuid"),entityData=this.get(),options={method:method,endpoint:type};entityId&&(options.method="PUT",options.endpoint+="/"+entityId),options.body=Object.keys(entityData).filter(function(key){return ENTITY_SYSTEM_PROPERTIES.indexOf(key)===-1}).reduce(function(data,key){return data[key]=entityData[key],data},{}),self._client.request(options,function(err,response){var entity=response.getEntity();entity&&(self.set(entity),self.set("type",/^\//.test(response.path)?response.path.substring(1):response.path)),err&&self._client.logging,doCallback(callback,[err,response,self],self)})},Miapp.Entity.prototype.changePassword=function(oldpassword,newpassword,callback){var self=this;if("function"==typeof oldpassword&&void 0===callback&&(callback=oldpassword,oldpassword=self.get("oldpassword"),newpassword=self.get("newpassword")),self.set({password:null,oldpassword:null,newpassword:null}),!(/^users?$/.test(self.get("type"))&&oldpassword&&newpassword))throw new MiappInvalidArgumentError("Invalid arguments passed to 'changePassword'");var options={method:"PUT",endpoint:"users/"+self.get("uuid")+"/password",body:{uuid:self.get("uuid"),username:self.get("username"),oldpassword:oldpassword,newpassword:newpassword}};self._client.request(options,function(err,response){err&&self._client.logging,doCallback(callback,[err,response,self],self)})},Miapp.Entity.prototype.fetch=function(callback){var endpoint,self=this;endpoint=this.getEndpoint();var options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,response){var entity=response.getEntity();entity&&self.set(entity),doCallback(callback,[err,response,self],self)})},Miapp.Entity.prototype.destroy=function(callback){var self=this,endpoint=this.getEndpoint(),options={method:"DELETE",endpoint:endpoint};this._client.request(options,function(err,response){err||self.set(null),doCallback(callback,[err,response,self],self)})},Miapp.Entity.prototype.connect=function(connection,entity,callback){this.addOrRemoveConnection("POST",connection,entity,callback)},Miapp.Entity.prototype.disconnect=function(connection,entity,callback){this.addOrRemoveConnection("DELETE",connection,entity,callback)},Miapp.Entity.prototype.addOrRemoveConnection=function(method,connection,entity,callback){var self=this;if(["POST","DELETE"].indexOf(method.toUpperCase())==-1)throw new MiappInvalidArgumentError("invalid method for connection call. must be 'POST' or 'DELETE'");var connecteeType=entity.get("type"),connectee=this.getEntityId(entity);if(!connectee)throw new MiappInvalidArgumentError("connectee could not be identified");var connectorType=this.get("type"),connector=this.getEntityId(this);if(!connector)throw new MiappInvalidArgumentError("connector could not be identified");var endpoint=[connectorType,connector,connection,connecteeType,connectee].join("/"),options={method:method,endpoint:endpoint};this._client.request(options,function(err,response){err&&self._client.logging,doCallback(callback,[err,response,self],self)})},Miapp.Entity.prototype.getEntityId=function(entity){var id;return id=isUUID(entity.get("uuid"))?entity.get("uuid"):"users"===this.get("type")||"user"===this.get("type")?entity.get("username"):entity.get("name")},Miapp.Entity.prototype.getConnections=function(connection,callback){var self=this,connectorType=this.get("type"),connector=this.getEntityId(this);if(connector){var endpoint=connectorType+"/"+connector+"/"+connection+"/",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging,self[connection]={};for(var length=data&&data.entities?data.entities.length:0,i=0;i<length;i++)"user"===data.entities[i].type?self[connection][data.entities[i].username]=data.entities[i]:self[connection][data.entities[i].name]=data.entities[i];doCallback(callback,[err,data,data.entities],self)})}else if("function"==typeof callback){var error="Error in getConnections - no uuid specified.";self._client.logging,doCallback(callback,[!0,error],self)}},Miapp.Entity.prototype.getGroups=function(callback){var self=this,endpoint="users/"+this.get("uuid")+"/groups",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging,self.groups=data.entities,doCallback(callback,[err,data,data.entities],self)})},Miapp.Entity.prototype.getActivities=function(callback){var self=this,endpoint=this.get("type")+"/"+this.get("uuid")+"/activities",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging;for(var entity in data.entities)data.entities[entity].createdDate=new Date(data.entities[entity].created).toUTCString();
self.activities=data.entities,doCallback(callback,[err,data,data.entities],self)})},Miapp.Entity.prototype.getFollowing=function(callback){var self=this,endpoint="users/"+this.get("uuid")+"/following",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging;for(var entity in data.entities){data.entities[entity].createdDate=new Date(data.entities[entity].created).toUTCString();var image=self._client.getDisplayImage(data.entities[entity].email,data.entities[entity].picture);data.entities[entity]._portal_image_icon=image}self.following=data.entities,doCallback(callback,[err,data,data.entities],self)})},Miapp.Entity.prototype.getFollowers=function(callback){var self=this,endpoint="users/"+this.get("uuid")+"/followers",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging;for(var entity in data.entities){data.entities[entity].createdDate=new Date(data.entities[entity].created).toUTCString();var image=self._client.getDisplayImage(data.entities[entity].email,data.entities[entity].picture);data.entities[entity]._portal_image_icon=image}self.followers=data.entities,doCallback(callback,[err,data,data.entities],self)})},Miapp.Client.prototype.createRole=function(roleName,permissions,callback){var options={type:"role",name:roleName};this.createEntity(options,function(err,response,entity){err?doCallback(callback,[err,response,self]):entity.assignPermissions(permissions,function(err,data){err?doCallback(callback,[err,response,self]):doCallback(callback,[err,data,data.data],self)})})},Miapp.Entity.prototype.getRoles=function(callback){var self=this,endpoint=this.get("type")+"/"+this.get("uuid")+"/roles",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging,self.roles=data.entities,doCallback(callback,[err,data,data.entities],self)})},Miapp.Entity.prototype.assignRole=function(roleName,callback){var entityID,self=this,type=self.get("type"),collection=type+"s";"user"==type&&null!=this.get("username")?entityID=self.get("username"):"group"==type&&null!=this.get("name")?entityID=self.get("name"):null!=this.get("uuid")&&(entityID=self.get("uuid")),"users"!=type&&"groups"!=type&&doCallback(callback,[new MiappError("entity must be a group or user","invalid_entity_type"),null,this],this);var endpoint="roles/"+roleName+"/"+collection+"/"+entityID,options={method:"POST",endpoint:endpoint};this._client.request(options,function(err,response){doCallback(callback,[err,response,self])})},Miapp.Entity.prototype.removeRole=function(roleName,callback){var entityID,self=this,type=self.get("type"),collection=type+"s";"user"==type&&null!=this.get("username")?entityID=this.get("username"):"group"==type&&null!=this.get("name")?entityID=this.get("name"):null!=this.get("uuid")&&(entityID=this.get("uuid")),"users"!=type&&"groups"!=type&&doCallback(callback,[new MiappError("entity must be a group or user","invalid_entity_type"),null,this],this);var endpoint="roles/"+roleName+"/"+collection+"/"+entityID,options={method:"DELETE",endpoint:endpoint};this._client.request(options,function(err,response){doCallback(callback,[err,response,self])})},Miapp.Entity.prototype.assignPermissions=function(permissions,callback){var entityID,self=this,type=this.get("type");"user"!=type&&"users"!=type&&"group"!=type&&"groups"!=type&&"role"!=type&&"roles"!=type&&doCallback(callback,[new MiappError("entity must be a group, user, or role","invalid_entity_type"),null,this],this),"user"==type&&null!=this.get("username")?entityID=this.get("username"):"group"==type&&null!=this.get("name")?entityID=this.get("name"):null!=this.get("uuid")&&(entityID=this.get("uuid"));var endpoint=type+"/"+entityID+"/permissions",options={method:"POST",endpoint:endpoint,body:{permission:permissions}};this._client.request(options,function(err,data){err&&self._client.logging,doCallback(callback,[err,data,data.data],self)})},Miapp.Entity.prototype.removePermissions=function(permissions,callback){var entityID,self=this,type=this.get("type");"user"!=type&&"users"!=type&&"group"!=type&&"groups"!=type&&"role"!=type&&"roles"!=type&&doCallback(callback,[new MiappError("entity must be a group, user, or role","invalid_entity_type"),null,this],this),"user"==type&&null!=this.get("username")?entityID=this.get("username"):"group"==type&&null!=this.get("name")?entityID=this.get("name"):null!=this.get("uuid")&&(entityID=this.get("uuid"));var endpoint=type+"/"+entityID+"/permissions",options={method:"DELETE",endpoint:endpoint,qs:{permission:permissions}};this._client.request(options,function(err,data){err&&self._client.logging,doCallback(callback,[err,data,data.params.permission],self)})},Miapp.Entity.prototype.getPermissions=function(callback){var self=this,endpoint=this.get("type")+"/"+this.get("uuid")+"/permissions",options={method:"GET",endpoint:endpoint};this._client.request(options,function(err,data){err&&self._client.logging;var permissions=[];if(data.data){var perms=data.data,count=0;for(var i in perms){count++;var perm=perms[i],parts=perm.split(":"),ops_part="",path_part=parts[0];parts.length>1&&(ops_part=parts[0],path_part=parts[1]),ops_part=ops_part.replace("*","get,post,put,delete");var ops=ops_part.split(","),ops_object={};ops_object.get="no",ops_object.post="no",ops_object.put="no",ops_object.delete="no";for(var j in ops)ops_object[ops[j]]="yes";permissions.push({operations:ops_object,path:path_part,perm:perm})}}self.permissions=permissions,doCallback(callback,[err,data,data.entities],self)})},Miapp.Collection=function(options){if(options&&(this._client=options.client,this._type=options.type,this.qs=options.qs||{},this._list=options.list||[],this._iterator=options.iterator||-1,this._previous=options.previous||[],this._next=options.next||null,this._cursor=options.cursor||null,options.list))for(var count=options.list.length,i=0;i<count;i++){var entity=this._client.restoreEntity(options.list[i]);this._list[i]=entity}},Miapp.isCollection=function(obj){return obj&&obj instanceof Miapp.Collection},Miapp.Collection.prototype.serialize=function(){var data={};data.type=this._type,data.qs=this.qs,data.iterator=this._iterator,data.previous=this._previous,data.next=this._next,data.cursor=this._cursor,this.resetEntityPointer();var i=0;for(data.list=[];this.hasNextEntity();){var entity=this.getNextEntity();data.list[i]=entity.serialize(),i++}return data=JSON.stringify(data)},Miapp.Collection.prototype.fetch=function(callback){var self=this,qs=this.qs;this._cursor?qs.cursor=this._cursor:delete qs.cursor;var options={method:"GET",endpoint:this._type,qs:this.qs};this._client.request(options,function(err,response){err&&self._client.logging||(self.saveCursor(response.cursor||null),self.resetEntityPointer(),self._list=response.getEntities().filter(function(entity){return isUUID(entity.uuid)}).map(function(entity){var ent=new Miapp.Entity({client:self._client});return ent.set(entity),ent.type=self._type,ent})),doCallback(callback,[err,response,self],self)})},Miapp.Collection.prototype.addEntity=function(entityObject,callback){var self=this;entityObject.type=this._type,this._client.createEntity(entityObject,function(err,response,entity){err||self.addExistingEntity(entity),doCallback(callback,[err,response,self],self)})},Miapp.Collection.prototype.addExistingEntity=function(entity){var count=this._list.length;this._list[count]=entity},Miapp.Collection.prototype.destroyEntity=function(entity,callback){var self=this;entity.destroy(function(err,response){err?(self._client.logging,doCallback(callback,[err,response,self],self)):self.fetch(callback),self.removeEntity(entity)})},Miapp.Collection.prototype.getEntitiesByCriteria=function(criteria){return this._list.filter(criteria)},Miapp.Collection.prototype.getEntityByCriteria=function(criteria){return this.getEntitiesByCriteria(criteria).shift()},Miapp.Collection.prototype.removeEntity=function(entity){var removedEntity=this.getEntityByCriteria(function(item){return entity.uuid===item.get("uuid")});return delete this._list[this._list.indexOf(removedEntity)],removedEntity},Miapp.Collection.prototype.getEntityByUUID=function(uuid,callback){var entity=this.getEntityByCriteria(function(item){return item.get("uuid")===uuid});if(entity)doCallback(callback,[null,entity,entity],this);else{var options={data:{type:this._type,uuid:uuid},client:this._client};entity=new Miapp.Entity(options),entity.fetch(callback)}},Miapp.Collection.prototype.getFirstEntity=function(){var count=this._list.length;return count>0?this._list[0]:null},Miapp.Collection.prototype.getLastEntity=function(){var count=this._list.length;return count>0?this._list[count-1]:null},Miapp.Collection.prototype.hasNextEntity=function(){var next=this._iterator+1,hasNextElement=next>=0&&next<this._list.length;return!!hasNextElement},Miapp.Collection.prototype.getNextEntity=function(){this._iterator++;var hasNextElement=this._iterator>=0&&this._iterator<=this._list.length;return!!hasNextElement&&this._list[this._iterator]},Miapp.Collection.prototype.hasPrevEntity=function(){var previous=this._iterator-1,hasPreviousElement=previous>=0&&previous<this._list.length;return!!hasPreviousElement},Miapp.Collection.prototype.getPrevEntity=function(){this._iterator--;var hasPreviousElement=this._iterator>=0&&this._iterator<=this._list.length;return!!hasPreviousElement&&this._list[this._iterator]},Miapp.Collection.prototype.resetEntityPointer=function(){this._iterator=-1},Miapp.Collection.prototype.saveCursor=function(cursor){this._next!==cursor&&(this._next=cursor)},Miapp.Collection.prototype.resetPaging=function(){this._previous=[],this._next=null,this._cursor=null},Miapp.Collection.prototype.hasNextPage=function(){return this._next},Miapp.Collection.prototype.getNextPage=function(callback){this.hasNextPage()&&(this._previous.push(this._cursor),this._cursor=this._next,this._list=[],this.fetch(callback))},Miapp.Collection.prototype.hasPreviousPage=function(){return this._previous.length>0},Miapp.Collection.prototype.getPreviousPage=function(callback){this.hasPreviousPage()&&(this._next=null,this._cursor=this._previous.pop(),this._list=[],this.fetch(callback))},Miapp.Group=function(options,callback){this._path=options.path,this._list=[],this._client=options.client,this._data=options.data||{},this._data.type="groups"},Miapp.Group.prototype=new Miapp.Entity,Miapp.Group.prototype.fetch=function(callback){var self=this,groupEndpoint="groups/"+this._path,memberEndpoint="groups/"+this._path+"/users",groupOptions={method:"GET",endpoint:groupEndpoint},memberOptions={method:"GET",endpoint:memberEndpoint};this._client.request(groupOptions,function(err,response){if(err)self._client.logging,doCallback(callback,[err,response],self);else{var entities=response.getEntities();if(entities&&entities.length){entities.shift();self._client.request(memberOptions,function(err,response){err&&self._client.logging||(self._list=response.getEntities().filter(function(entity){return isUUID(entity.uuid)}).map(function(entity){return new Miapp.Entity({type:entity.type,client:self._client,uuid:entity.uuid,response:entity})})),doCallback(callback,[err,response,self],self)})}}})},Miapp.Group.prototype.members=function(callback){return this._list},Miapp.Group.prototype.add=function(options,callback){var self=this;options.user?(options={method:"POST",endpoint:"groups/"+this._path+"/users/"+options.user.get("username")},this._client.request(options,function(error,response){error?doCallback(callback,[error,response,self],self):self.fetch(callback)})):doCallback(callback,[new MiappError("no user specified","no_user_specified"),null,this],this)},Miapp.Group.prototype.remove=function(options,callback){var self=this;options.user?(options={method:"DELETE",endpoint:"groups/"+this._path+"/users/"+options.user.username},this._client.request(options,function(error,response){error?doCallback(callback,[error,response,self],self):self.fetch(callback)})):doCallback(callback,[new MiappError("no user specified","no_user_specified"),null,this],this)},Miapp.Group.prototype.feed=function(callback){var self=this,options={method:"GET",endpoint:"groups/"+this._path+"/feed"};this._client.request(options,function(err,response){doCallback(callback,[err,response,self],self)})},Miapp.Group.prototype.createGroupActivity=function(options,callback){var self=this,user=options.user,entity=new Miapp.Entity({client:this._client,data:{actor:{displayName:user.get("username"),uuid:user.get("uuid"),username:user.get("username"),email:user.get("email"),picture:user.get("picture"),image:{duration:0,height:80,url:user.get("picture"),width:80}},verb:"post",content:options.content,type:"groups/"+this._path+"/activities"}});entity.save(function(err,response,entity){doCallback(callback,[err,response,self])})},Miapp.Counter=function(options){this._client=options.client,this._data=options.data||{},this._data.category=options.category||"UNKNOWN",this._data.timestamp=options.timestamp||0,this._data.type="events",this._data.counters=options.counters||{}};var COUNTER_RESOLUTIONS=["all","minute","five_minutes","half_hour","hour","six_day","day","week","month"];Miapp.Counter.prototype=new Miapp.Entity,Miapp.Counter.prototype.fetch=function(callback){this.getData({},callback)},Miapp.Counter.prototype.increment=function(options,callback){var self=this,name=options.name,value=options.value;return name?isNaN(value)?doCallback(callback,[new MiappInvalidArgumentError("'value' for increment, decrement must be a number"),null,self],self):(self._data.counters[name]=parseInt(value)||1,self.save(callback)):doCallback(callback,[new MiappInvalidArgumentError("'name' for increment, decrement must be a number"),null,self],self)},Miapp.Counter.prototype.decrement=function(options,callback){var self=this,name=options.name,value=options.value;self.increment({name:name,value:-(parseInt(value)||1)},callback)},Miapp.Counter.prototype.reset=function(options,callback){var self=this,name=options.name;self.increment({name:name,value:0},callback)},Miapp.Counter.prototype.getData=function(options,callback){var start_time,end_time,start=options.start||0,end=options.end||Date.now(),resolution=(options.resolution||"all").toLowerCase(),counters=options.counters||Object.keys(this._data.counters),res=(resolution||"all").toLowerCase();COUNTER_RESOLUTIONS.indexOf(res)===-1&&(res="all"),start_time=getSafeTime(start),end_time=getSafeTime(end);var self=this,params=Object.keys(counters).map(function(counter){return["counter",encodeURIComponent(counters[counter])].join("=")});params.push("resolution="+res),params.push("start_time="+String(start_time)),params.push("end_time="+String(end_time));var endpoint="counters?"+params.join("&");this._client.request({endpoint:endpoint},function(err,data){return data.counters&&data.counters.length&&data.counters.forEach(function(counter){self._data.counters[counter.name]=counter.value||counter.values}),doCallback(callback,[err,data,self],self)})},Miapp.Folder=function(options,callback){var self=this;self._client=options.client,self._data=options.data||{},self._data.type="folders";var missingData=["name","owner","path"].some(function(required){return!(required in self._data)});return missingData?doCallback(callback,[new MiappInvalidArgumentError("Invalid asset data: 'name', 'owner', and 'path' are required properties."),null,self],self):void self.save(function(err,response){err?doCallback(callback,[new MiappError(response),response,self],self):(response&&response.entities&&response.entities.length&&self.set(response.entities[0]),doCallback(callback,[null,response,self],self))})},Miapp.Folder.prototype=new Miapp.Entity,Miapp.Folder.prototype.fetch=function(callback){var self=this;Miapp.Entity.prototype.fetch.call(self,function(err,data){err?doCallback(callback,[null,data,self],self):self.getAssets(function(err,response){err?doCallback(callback,[new MiappError(response),resonse,self],self):doCallback(callback,[null,self],self)})})},Miapp.Folder.prototype.addAsset=function(options,callback){var self=this;if("asset"in options){var asset=null;switch(typeof options.asset){case"object":asset=options.asset,asset instanceof Miapp.Entity||(asset=new Miapp.Asset(asset));break;case"string":isUUID(options.asset)&&(asset=new Miapp.Asset({client:self._client,data:{uuid:options.asset,type:"assets"}}))}asset&&asset instanceof Miapp.Entity&&asset.fetch(function(err,data){if(err)doCallback(callback,[new MiappError(data),data,self],self);else{var endpoint=["folders",self.get("uuid"),"assets",asset.get("uuid")].join("/"),options={method:"POST",endpoint:endpoint};self._client.request(options,callback)}})}else doCallback(callback,[new MiappInvalidArgumentError("No asset specified"),null,self],self)},Miapp.Folder.prototype.removeAsset=function(options,callback){var self=this;if("asset"in options){var asset=null;switch(typeof options.asset){case"object":asset=options.asset;break;case"string":isUUID(options.asset)&&(asset=new Miapp.Asset({client:self._client,data:{uuid:options.asset,type:"assets"}}))}if(asset&&null!==asset){var endpoint=["folders",self.get("uuid"),"assets",asset.get("uuid")].join("/");self._client.request({method:"DELETE",endpoint:endpoint},function(err,response){err?doCallback(callback,[new MiappError(response),response,self],self):doCallback(callback,[null,response,self],self)})}}else doCallback(callback,[new MiappInvalidArgumentError("No asset specified"),null,self],self)},Miapp.Folder.prototype.getAssets=function(callback){return this.getConnections("assets",callback)},XMLHttpRequest.prototype.sendAsBinary||(XMLHttpRequest.prototype.sendAsBinary=function(sData){for(var nBytes=sData.length,ui8Data=new Uint8Array(nBytes),nIdx=0;nIdx<nBytes;nIdx++)ui8Data[nIdx]=255&sData.charCodeAt(nIdx);this.send(ui8Data)}),Miapp.Asset=function(options,callback){var self=this;self._client=options.client,self._data=options.data||{},self._data.type="assets";var missingData=["name","owner","path"].some(function(required){return!(required in self._data)});missingData?doCallback(callback,[new MiappError("Invalid asset data: 'name', 'owner', and 'path' are required properties."),null,self],self):self.save(function(err,data){err?doCallback(callback,[new MiappError(data),data,self],self):(data&&data.entities&&data.entities.length&&self.set(data.entities[0]),doCallback(callback,[null,data,self],self))})},Miapp.Asset.prototype=new Miapp.Entity,Miapp.Asset.prototype.addToFolder=function(options,callback){var self=this;if("folder"in options&&isUUID(options.folder)){Miapp.Folder({uuid:options.folder},function(err,folder){if(err)doCallback(callback,[MiappError.fromResponse(folder),folder,self],self);else{var endpoint=["folders",folder.get("uuid"),"assets",self.get("uuid")].join("/"),options={method:"POST",endpoint:endpoint};this._client.request(options,function(err,response){err?doCallback(callback,[MiappError.fromResponse(folder),response,self],self):doCallback(callback,[null,folder,self],self)})}})}else doCallback(callback,[new MiappError("folder not specified"),null,self],self)},Miapp.Entity.prototype.attachAsset=function(file,callback){if(!(window.File&&window.FileReader&&window.FileList&&window.Blob))return void doCallback(callback,[new MiappError("The File APIs are not fully supported by your browser."),null,this],this);var self=this,args=arguments,type=this._data.type,attempts=self.get("attempts");if(isNaN(attempts)&&(attempts=3),"assets"!=type&&"asset"!=type)var endpoint=[this._client.URI,this._client.orgName,this._client.appName,type,self.get("uuid")].join("/");else{self.set("content-type",file.type),self.set("size",file.size);var endpoint=[this._client.URI,this._client.orgName,this._client.appName,"assets",self.get("uuid"),"data"].join("/")}var xhr=new XMLHttpRequest;xhr.open("POST",endpoint,!0),xhr.onerror=function(err){doCallback(callback,[new MiappError("The File APIs are not fully supported by your browser.")],xhr,self)},xhr.onload=function(ev){xhr.status>=500&&attempts>0?(self.set("attempts",--attempts),setTimeout(function(){self.attachAsset.apply(self,args)},100)):xhr.status>=300?(self.set("attempts"),doCallback(callback,[new MiappError(JSON.parse(xhr.responseText)),xhr,self],self)):(self.set("attempts"),self.fetch(),doCallback(callback,[null,xhr,self],self))};var fr=new FileReader;fr.onload=function(){var binary=fr.result;"assets"!==type&&"asset"!==type||(xhr.overrideMimeType("application/octet-stream"),xhr.setRequestHeader("Content-Type","application/octet-stream")),xhr.sendAsBinary(binary)},fr.readAsBinaryString(file)},Miapp.Asset.prototype.upload=function(data,callback){this.attachAsset(data,function(err,response){err?doCallback(callback,[new MiappError(err),response,self],self):doCallback(callback,[null,response,self],self)})},Miapp.Entity.prototype.downloadAsset=function(callback){var endpoint,self=this,type=this._data.type,xhr=new XMLHttpRequest;endpoint="assets"!=type&&"asset"!=type?[this._client.URI,this._client.orgName,this._client.appName,type,self.get("uuid")].join("/"):[this._client.URI,this._client.orgName,this._client.appName,"assets",self.get("uuid"),"data"].join("/"),xhr.open("GET",endpoint,!0),xhr.responseType="blob",xhr.onload=function(ev){var blob=xhr.response;"assets"!=type&&"asset"!=type?doCallback(callback,[null,blob,xhr],self):doCallback(callback,[null,xhr,self],self)},xhr.onerror=function(err){callback(!0,err),doCallback(callback,[new MiappError(err),xhr,self],self)},"assets"!=type&&"asset"!=type?xhr.setRequestHeader("Accept",self._data["file-metadata"]["content-type"]):xhr.overrideMimeType(self.get("content-type")),xhr.send()},Miapp.Asset.prototype.download=function(callback){this.downloadAsset(function(err,response){err?doCallback(callback,[new MiappError(err),response,self],self):doCallback(callback,[null,response,self],self)})},function(global){function MiappError(message,name,timestamp,duration,exception){this.message=message,this.name=name,this.timestamp=timestamp||Date.now(),this.duration=duration||0,this.exception=exception}function MiappHTTPResponseError(message,name,timestamp,duration,exception){this.message=message,this.name=name,this.timestamp=timestamp||Date.now(),this.duration=duration||0,this.exception=exception}function MiappInvalidHTTPMethodError(message,name,timestamp,duration,exception){this.message=message,this.name=name||"invalid_http_method",this.timestamp=timestamp||Date.now(),this.duration=duration||0,this.exception=exception}function MiappInvalidURIError(message,name,timestamp,duration,exception){this.message=message,this.name=name||"invalid_uri",this.timestamp=timestamp||Date.now(),this.duration=duration||0,this.exception=exception}function MiappInvalidArgumentError(message,name,timestamp,duration,exception){this.message=message,this.name=name||"invalid_argument",this.timestamp=timestamp||Date.now(),this.duration=duration||0,this.exception=exception}function MiappKeystoreDatabaseUpgradeNeededError(message,name,timestamp,duration,exception){this.message=message,this.name=name,this.timestamp=timestamp||Date.now(),this.duration=duration||0,this.exception=exception}var short,name="MiappError",_name=global[name],_short=short&&void 0!==short?global[short]:void 0;return MiappError.prototype=new Error,MiappError.prototype.constructor=MiappError,MiappError.fromResponse=function(response){return response&&"undefined"!=typeof response?new MiappError(response.error_description,response.error,response.timestamp,response.duration,response.exception):new MiappError},MiappError.createSubClass=function(name){return name in global&&global[name]?global[name]:(global[name]=function(){},global[name].name=name,global[name].prototype=new MiappError,global[name])},MiappHTTPResponseError.prototype=new MiappError,MiappInvalidHTTPMethodError.prototype=new MiappError,MiappInvalidURIError.prototype=new MiappError,MiappInvalidArgumentError.prototype=new MiappError,MiappKeystoreDatabaseUpgradeNeededError.prototype=new MiappError,global.MiappHTTPResponseError=MiappHTTPResponseError,global.MiappInvalidHTTPMethodError=MiappInvalidHTTPMethodError,global.MiappInvalidURIError=MiappInvalidURIError,global.MiappInvalidArgumentError=MiappInvalidArgumentError,global.MiappKeystoreDatabaseUpgradeNeededError=MiappKeystoreDatabaseUpgradeNeededError,global[name]=MiappError,void 0!==short&&(global[short]=MiappError),global[name].noConflict=function(){return _name&&(global[name]=_name),void 0!==short&&(global[short]=_short),MiappError},global[name]}(this||window);var SrvMiapp=function(){"use strict";function Service(logger,promise){this.logger=logger,this.promise=promise,this.logger.log("miapp.sdk.service : init"),this.miappClient=null,this.currentUser=getObjectFromLocalStorage("miappCurrentUser")||null,this.miappId=null,this.miappSalt="SALT_TOKEN",this.miappOrg=null,this.miappAppVersion=null,this.miappIsOffline=getObjectFromLocalStorage("miappIsOffline")||!1,this.miappURI=getObjectFromLocalStorage("miappURI")||"https://miapp.io/api",this.miappDBURI=getObjectFromLocalStorage("miappDBURI")||"https://couchdb_notfound",this._db=new PouchDB("miapp_db",{adapter:"websql"}),this._dbRecordCount=0,this._dbInitialized=!1}function generateObjectUniqueId(appName,type,name){var now=new Date,simpleDate=""+now.getYear()+now.getMonth()+now.getDate()+now.getHours()+now.getMinutes(),sequId=++_srvDataUniqId,UId="";return appName&&appName.charAt(0)&&(UId+=appName.charAt(0)),type&&type.length>3&&(UId+=type.substring(0,4)),name&&name.length>3&&(UId+=name.substring(0,4)),UId+=simpleDate+"_"+sequId}function setObjectFromLocalStorage(id,object){var jsonObj=JSON.stringify(object);return window.localStorage&&window.localStorage.setItem(id,jsonObj),jsonObj}function getObjectFromLocalStorage(id){var retrievedObject;window.localStorage&&(retrievedObject=window.localStorage.getItem(id));var obj=JSON.parse(retrievedObject);return obj}function removeObjectFromLocalStorage(id){window.localStorage&&window.localStorage.removeItem(id)}Service.prototype._testPromise=function(a){return a?this.promise.resolve("test promise ok "+a):new this.promise(function(resolve,reject){resolve("test promise ok")})},Service.prototype.init=function(miappId,miappSalt,isOffline){this.miappIsOffline="undefined"==typeof isOffline?this.miappIsOffline:isOffline,this.miappIsOffline||(this.miappClient=new Miapp.Client({orgName:"miappio",appName:miappId,logging:!0,buildCurl:!1,URI:this.miappURI})),this.miappId=miappId,this.miappOrg=null,this.miappAppVersion=null},Service.prototype.setAuthEndpoint=function(endpointURI){this.miappURI=endpointURI,setObjectFromLocalStorage("miappURI",this.miappURI)},Service.prototype.setDBEndpoint=function(endpointURI){this.miappDBURI=endpointURI,setObjectFromLocalStorage("miappDBURI",this.miappDBURI)},Service.prototype.setOffline=function(b){this.miappIsOffline=1==b,setObjectFromLocalStorage("miappIsOffline",this.miappIsOffline)},Service.prototype.isLogin=function(){return!!this.currentUser},Service.prototype.login=function(login,password,updateProperties){var self=this;return new self.promise(function(resolve,reject){if(!self.miappClient&&!self.miappIsOffline)return void reject("miapp.sdk.service.login : not initialized. Did you miapp.sdk.service.init() ?");var encrypted_json_str=password;if(self.logger.log("miapp.sdk.service.login : "+login+" / "+encrypted_json_str),self.currentUser){if(self.currentUser.email===login&&self.currentUser.password===encrypted_json_str)return void resolve(self.currentUser);self.currentUser=null}if(self.miappIsOffline){var offlineUser={};return offlineUser.email=login,offlineUser.password=encrypted_json_str,self.setCurrentUser(offlineUser),void resolve(self.currentUser)}self.miappClient.loginMLE(self.miappId,login,encrypted_json_str,updateProperties,function(err,loginUser){err?(self.logger.error("miapp.sdk.service.login error : "+err),reject(err)):(loginUser.email=login,self.setCurrentUser(loginUser),resolve(self.currentUser))})})},Service.prototype.logoff=function(){var self=this;return self.currentUser?self.deleteUser(self.currentUser._id):self.$q.reject("miapp.sdk.service not login")},Service.prototype.deleteUser=function(userIDToDelete){var self=this;return self.miappIsOffline?self.promise.resolve(null):self.miappClient?new self.promise(function(resolve,reject){self.miappClient.deleteUserMLE(userIDToDelete,function(err){return err?reject(err):(self.currentUser=null,removeObjectFromLocalStorage("miappCurrentUser"),resolve(self.currentUser))})}):self.promise.reject("miapp.sdk.service not initialized")},Service.prototype.syncDb=function(){var self=this;if(self.logger.log("miapp.sdk.service.syncDb"),self.miappIsOffline)return self.promise.resolve();var pouchdbEndpoint=self.miappDBURI,getendpoint=self.miappClient?self.miappClient.getEndpoint():null;return!pouchdbEndpoint&&getendpoint&&(pouchdbEndpoint=getendpoint),self.currentUser&&self.currentUser.email&&pouchdbEndpoint&&pouchDB?(self.logger.log("miapp.sdk.service.syncDb call"),new self.promise(function(resolve,reject){self._db.sync(pouchdbEndpoint,{filter:function(doc){if(doc.appUser_Id==self.currentUser.email)return doc}}).on("complete",function(info){self.logger.log("miapp.sdk.service.syncDb : db complete : "+info),resolve()}).on("error",function(err){self.logger.error("miapp.sdk.service.syncDb : db error, we set db temporary offline : "+err),self.miappIsOffline=!0,reject(err)}).on("change",function(info){self.logger.log("miapp.sdk.service.syncDb : db change : "+info)}).on("paused",function(err){self.logger.log("miapp.sdk.service.syncDb : db paused : "+err)}).on("active",function(){self.logger.log("miapp.sdk.service.syncDb : db activate")}).on("denied",function(info){self.logger.error("miapp.sdk.service.syncDb : db denied, we set db temporary offline : "+info),self.miappIsOffline=!0,reject("miapp.sdk.service.syncDb : db denied : "+info)})})):self.promise.reject("miapp.sdk.service.syncDb : DB sync impossible. Need a user logged in. ("+pouchdbEndpoint+" -"+self.currentUser+")")},Service.prototype.putInDb=function(data){var self=this;if(!self.currentUser||!self.currentUser._id||!self._db)return self.promise.reject("miapp.sdk.service.putInDb : DB put impossible. Need a user logged in. ("+self.currentUser+")");data.miappUserId=self.currentUser._id,data.miappOrgId=self.appName,data.miappAppVersion=self.appVersion;var dataId=data._id;return dataId||(dataId=generateObjectUniqueId(self.appName)),delete data._id,data._id=dataId,new self.promise(function(resolve,reject){self._db.put(data,function(err,response){return response&&response.ok&&response.id&&response.rev?(data._id=response.id,data._rev=response.rev,self._dbRecordCount++,self.logger.log("updatedData: "+data._id+" - "+data._rev),void resolve(data)):void reject(err)})})},Service.prototype.findInDb=function(id){var self=this;return self.currentUser&&self.currentUser._id&&self._db?self._db.get(id):self.promise.reject("miapp.sdk.service.findInDb : need a user logged in. ("+self.currentUser+")")},Service.prototype.findAllInDb=function(){var self=this;return self.currentUser&&self.currentUser._id&&self._db?self._db.allDocs({include_docs:!0,descending:!0}):self.promise.reject("miapp.sdk.service.findAllInDb : need a user logged in. ("+self.currentUser+")")};var _srvDataUniqId=0;return Service.prototype.isDbEmpty=function(){var self=this;if(self.logger.log("miapp.sdk.service.isDbEmpty .."),!self._db){var error="miapp.sdk.service.isDbEmpty : DB search impossible. Need a user logged in. ("+self.currentUser+")";return self.logger.error(error),self.promise.reject(error)}return self.logger.log("miapp.sdk.service.isDbEmpty call"),new self.promise(function(resolve,reject){self._db.allDocs({filter:function(doc){return self.currentUser?doc.miappUserId==self.currentUser._id?doc:void 0:doc}},function(err,response){return self.logger.log("miapp.sdk.service.isDbEmpty callback"),err||!response?void reject(err):(self._dbRecordCount=response.total_rows,response.total_rows&&response.total_rows>0?void resolve(!1):(self.logger.log("miapp.sdk.service.isDbEmpty callback: "+response.total_rows),
void resolve(!0)))})})},Service.prototype.setCurrentUser=function(user){var self=this;if(!user)return self.logger.log("miapp.sdk.service.setCurrentUser : need a valid user");var firstUserId=user._id;!firstUserId&&self.currentUser&&(firstUserId=self.currentUser._id),firstUserId||(firstUserId=generateObjectUniqueId(self.appName,"user")),user._id=firstUserId,user.miappUserId=firstUserId,user.miappOrgId=self.appName,user.miappAppVersion=self.appVersion,self.currentUser=user,setObjectFromLocalStorage("miappCurrentUser",self.currentUser),self.logger.log("miapp.sdk.service.setCurrentUser :"),self.logger.log(self.currentUser)},Service.prototype.putFirstUserInEmptyDb=function(firstUser){var self=this;if(!(firstUser&&self.currentUser&&self.currentUser.email&&self._db))return self.promise.reject("miapp.sdk.service.putFirstUserInEmptyBd : DB put impossible. Need a user logged in. ("+self.currentUser+")_");var firstUserId=firstUser._id;return firstUserId||(firstUserId=self.currentUser._id),firstUserId||(firstUserId=generateObjectUniqueId(self.appName,"user")),firstUser.miappUserId=firstUserId,firstUser.miappOrgId=self.appName,firstUser.miappAppVersion=self.appVersion,delete firstUser._id,firstUser._id=firstUserId,new self.promise(function(resolve,reject){self._db.put(firstUser,function(err,response){return response&&response.ok&&response.id&&response.rev?(firstUser._id=response.id,firstUser._rev=response.rev,self.logger.log("miapp.sdk.service.putFirstUserInEmptyBd : firstUser: "+firstUser._id+" - "+firstUser._rev),self._dbRecordCount++,self.setCurrentUser(firstUser),resolve(firstUser)):reject(err)})})},Service.prototype.becarefulCleanDb=function(){var self=this;return self.logger.log("miapp.sdk.service.becarefulCleanDb"),self._db?new self.promise(function(resolve,reject){self._db.destroy(function(err,info){return err?reject(err):(self._db=new PouchDB("miapp_db",{adapter:"websql"}),delete self.currentUser,self.currentUser=null,self._dbRecordCount=0,removeObjectFromLocalStorage("miappCurrentUser"),self.logger.log("miapp.sdk.service.becarefulCleanDb .. done : "+info),resolve())})}):self.promise.reject("miapp.sdk.service.becarefulCleanDb : DB clean impossible.")},Service.prototype.initDBWithLogin=function(login,password){var self=this;return self.logger.log("miapp.sdk.service.initDBWithLogin"),self._dbInitialized?self.promise.reject("miapp.sdk.service.initDBWithLogin : DB already initialized. Do the miapp.sdk.service.login() once each app start."):new self.promise(function(resolve,reject){self.isDbEmpty().then(function(isEmpty){return!isEmpty&&self.currentUser?(self._dbInitialized=!0,void resolve(self.currentUser)):void self.becarefulCleanDb().then(function(msg){return self.login(login,password)}).then(function(firstUser){return firstUser&&!self.currentUser&&self.setCurrentUser(firstUser),self.syncDb()}).then(function(ret){self.currentUser?(self._dbInitialized=!0,resolve(self.currentUser)):reject("miapp.sdk.service.initDBWithLogin : Pb with user get."+ret)}).catch(function(err){reject(err)})}).catch(function(err){reject(err)})})},Service.prototype.syncComplete=function(fnInitFirstData,service){var self=this;return self.logger.log("miapp.sdk.service.syncComplete"),self.currentUser&&self._db?new self.promise(function(resolve,reject){self.isDbEmpty().then(function(isEmpty){if(isEmpty&&fnInitFirstData){var ret=fnInitFirstData(service);if(ret&&ret.catch instanceof Function)return ret;"string"==typeof ret&&self.logger.log(ret)}return self.promise.resolve("miapp.sdk.service.syncComplete : ready to sync")}).then(function(ret){return"string"==typeof ret&&self.logger.log(ret),self.syncDb()}).then(function(err){return err?reject(err):(self.logger.log("miapp.sdk.service.syncComplete sync resolved"),self._db.info())}).then(function(result){self._dbRecordCount=result.doc_count,self.logger.log("miapp.sdk.service.syncComplete _dbRecordCount : "+self._dbRecordCount),resolve(self._dbRecordCount)}).catch(function(err){var errMessage=err?err:"miapp.sdk.service.syncComplete : DB pb with getting data";reject(errMessage)})}):self.promise.reject("miapp.sdk.service.syncComplete : DB sync impossible. Did you miapp.sdk.service.login() ?")},Service}();