!function(e,t){"object"==typeof exports&&"undefined"!=typeof module?t(exports,require("@angular/core"),require("@angular/common")):"function"==typeof define&&define.amd?define(["exports","@angular/core","@angular/common"],t):t(e["miappio-sdk"]={},e.ng.core,e.ng.common)}(this,function(e,t,n){"use strict";var i="2.0.19",r=function(){function e(){}return e.encode=function(e){return e?btoa(encodeURIComponent(e).replace(/%([0-9A-F]{2})/g,function(e,t){return String.fromCharCode(parseInt("0x"+t,16))})):null},e.decode=function(e){return e?decodeURIComponent(atob(e).split("").map(function(e){return"%"+("00"+e.charCodeAt(0).toString(16)).slice(-2)}).join("")):null},e}(),o=function(){function e(e,t){if(this.storageKey=t,this.version="0.1",this.storage=e||window.localStorage,!this.storage)throw new Error("miapp.LocalStorageFactory needs a storageService!")}return e.prototype.set=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=typeof t;if("undefined"===n)t="null";else if(null===t)t="null";else if("string"===n)t=JSON.stringify({string:t});else if("number"===n)t=JSON.stringify({number:t});else if("boolean"===n)t=JSON.stringify({bool:t});else{if("object"!==n)throw new TypeError("Value type "+n+" is invalid. It must be null, undefined, xml, string, number, boolean or object");t=JSON.stringify({json:t})}return this.storage.setItem(e,t),t},e.prototype.get=function(e,t){e=this.storageKey+e,this.checkKey(e);var n=this.storage.getItem(e);if(null!==n){if("null"===n)return null;var i=JSON.parse(n);return"string"in i?i.string:"number"in i?i.number.valueOf():"bool"in i?i.bool.valueOf():i.json}return t||null},e.prototype.remove=function(e){e=this.storageKey+e,this.checkKey(e);var t=null!==this.storage.getItem(e);return this.storage.removeItem(e),t},e.prototype.clear=function(){var e=this.storage.length>0;return this.storage.clear(),e},e.prototype.size=function(){return this.storage.length},e.prototype.foreach=function(e,t){for(var n=this.storage.length,i=0;i<n;i++){var r=this.storage.key(i),o=this.get(r);t?e.call(t,o):e(o)}return n},e.prototype.checkKey=function(e){if(!e||"string"!=typeof e)throw new TypeError("Key type must be string");return!0},e}(),s=function(){function e(){}return e.encrypt=function(t,n){for(var i="",o=0;o<t.length;o++)i+=String.fromCharCode(t[o].charCodeAt(0).toString(10)^e.keyCharAt(n,o));return r.encode(i)},e.decrypt=function(t,n){var i="";t=r.decode(t);for(var o=0;o<t.length;o++)i+=String.fromCharCode(t[o].charCodeAt(0).toString(10)^e.keyCharAt(n,o));return i},e.keyCharAt=function(e,t){return e[Math.floor(t%e.length)].charCodeAt(0).toString(10)},e}(),a=function(){function e(){this.DEFAULT_CONTENT_TYPE="application/x-www-form-urlencoded; charset=UTF-8"}return e.prototype.send=function(e){var t,n;return null==e&&(e={}),t={method:"GET",data:null,headers:{},async:!0,username:null,password:null,withCredentials:!1},e=Object.assign({},t,e),new Promise((n=this,function(t,i){var r,o,s,a,c;if(XMLHttpRequest)if("string"==typeof e.url&&0!==e.url.length){n._xhr=c=new XMLHttpRequest,c.onload=function(){var e;n._detachWindowUnload();try{e=n._getResponseText()}catch(r){return void n._handleError("parse",i,null,"invalid JSON response")}return t({url:n._getResponseUrl(),status:c.status,statusText:c.statusText,responseText:e,headers:n._getHeaders(),xhr:c})},c.onerror=function(){return n._handleError("error",i)},c.ontimeout=function(){return n._handleError("timeout",i)},c.onabort=function(){return n._handleError("abort",i)},n._attachWindowUnload(),c.open(e.method,e.url,e.async,e.username,e.password),e.withCredentials&&(c.withCredentials=!0),null==e.data||e.headers["Content-Type"]||(e.headers["Content-Type"]=n.DEFAULT_CONTENT_TYPE),s=e.headers;for(o in s)s.hasOwnProperty(o)&&(a=s[o],c.setRequestHeader(o,a));try{return c.send(e.data)}catch(p){return r=p,n._handleError("send",i,null,r.toString())}}else n._handleError("url",i,null,"URL is a required parameter");else n._handleError("browser",i,null,"browser doesn't support XMLHttpRequest")}))},e.prototype.getXHR=function(){return this._xhr},e.prototype._attachWindowUnload=function(){if(this._unloadHandler=this._handleWindowUnload.bind(this),window.attachEvent)return window.attachEvent("onunload",this._unloadHandler)},e.prototype._detachWindowUnload=function(){if(window.detachEvent)return window.detachEvent("onunload",this._unloadHandler)},e.prototype._getHeaders=function(){return this._parseHeaders(this._xhr.getAllResponseHeaders())},e.prototype._getResponseText=function(){var e;switch(e="string"==typeof this._xhr.responseText?this._xhr.responseText:"",(this._xhr.getResponseHeader("Content-Type")||"").split(";")[0]){case"application/json":case"text/javascript":e=JSON.parse(e+"")}return e},e.prototype._getResponseUrl=function(){return null!=this._xhr.responseURL?this._xhr.responseURL:/^X-Request-URL:/m.test(this._xhr.getAllResponseHeaders())?this._xhr.getResponseHeader("X-Request-URL"):""},e.prototype._handleError=function(e,t,n,i){return this._detachWindowUnload(),t({reason:e,status:n||this._xhr.status,statusText:i||this._xhr.statusText,xhr:this._xhr})},e.prototype._handleWindowUnload=function(){return this._xhr.abort()},e.prototype.trim=function(e){return e.replace(/^\s*|\s*$/g,"")},e.prototype.isArray=function(e){return"[object Array]"===Object.prototype.toString.call(e)},e.prototype.forEach=function(e,t){"[object Array]"===toString.call(e)?this.forEachArray(e,t,this):"string"==typeof e?this.forEachString(e,t,this):this.forEachObject(e,t,this)},e.prototype.forEachArray=function(e,t,n){for(var i=0,r=e.length;i<r;i++)e.hasOwnProperty(i)&&t.call(n,e[i],i,e)},e.prototype.forEachString=function(e,t,n){for(var i=0,r=e.length;i<r;i++)t.call(n,e.charAt(i),i,e)},e.prototype.forEachObject=function(e,t,n){for(var i in e)e.hasOwnProperty(i)&&t.call(n,e[i],i,e)},e.prototype._parseHeaders=function(e){var t=this;if(!e)return{};var n={};return this.forEach(this.trim(e).split("\n"),function(e){var i=e.indexOf(":"),r=t.trim(e.slice(0,i)).toLowerCase(),o=t.trim(e.slice(i+1));"undefined"==typeof n[r]?n[r]=o:t.isArray(n[r])?n[r].push(o):n[r]=[n[r],o]}),n},e}(),c=function(){function e(){this.xhr=new a}return e.prototype.post=function(e){var t={method:"POST",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",Promise.reject(e)):Promise.resolve(e.responseText)})},e.prototype.put=function(e){var t={method:"PUT",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",Promise.reject(e)):Promise.resolve(e.responseText)})},e.prototype["delete"]=function(e){var t={method:"DELETE",url:e.url,data:JSON.stringify(e.data)};return e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",Promise.reject(e)):Promise.resolve(e.responseText)})},e.prototype.get=function(e){var t={method:"GET",url:e.url};return e.data&&(t.data=e.data),e.headers&&(t.headers=e.headers),this.xhr.send(t).then(function(e){return e.status&&(parseInt(e.status,10)<200||parseInt(e.status,10)>=300)?(e.reason="status",Promise.reject(e)):Promise.resolve(e.responseText)})},e}(),p=function(){function e(e,t,n,i){this.appId=e,this.URI=t,this.storage=n,this.sdk=i;var r=this.storage.get("uuid")||"uuid-"+Math.random(),o=this.storage.get("info");!o&&window&&window.navigator&&(o=window.navigator.appName+"@"+window.navigator.appVersion+"-"+window.navigator.userAgent),window&&window.device&&window.device.uuid&&(r=window.device.uuid),this.setClientUuid(r),this.setClientInfo(o),this.refreshToken=this.storage.get("refreshToken"),this.clientId=this.storage.get("clientId")}return e.prototype.setClientId=function(e){this.clientId=e,this.storage.set("clientId",this.clientId)},e.prototype.setClientUuid=function(e){this.clientUuid=e,this.storage.set("clientUuid",this.clientUuid)},e.prototype.setClientInfo=function(e){this.clientInfo=e},e.prototype.setRefreshToken=function(e){this.refreshToken=e,this.storage.set("refreshToken",this.refreshToken)},e.prototype.login=function(e,t,n){var i=this;if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,msg:"no api uri"});var r=this.URI+"/users",o={name:e,username:e,email:e,password:t};return(new c).post({url:r,data:o,headers:{"Content-Type":"application/json",Accept:"text/json"}}).then(function(e){i.setClientId(e._id);var n=i.URI+"/oauth/token",r={grant_type:"client_credentials",client_id:i.clientId,client_secret:t,client_udid:i.clientUuid,client_info:i.clientInfo,audience:i.appId,scope:JSON.stringify(i.sdk)};return(new c).post({url:n,data:r,headers:{"Content-Type":"application/json",Accept:"text/json"}})})},e.prototype.reAuthenticate=function(){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,msg:"no api uri"});var t=this.URI+"/oauth/token",n={grant_type:"refresh_token",client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk),refresh_token:this.refreshToken,refresh_extra:e.refreshCount++};return(new c).post({url:t,data:n,headers:{"Content-Type":"application/json",Accept:"text/json"}})},e.prototype.logout=function(){if(!this.URI)return console.error("no api uri"),Promise.reject({code:408,msg:"no api uri"});var t=this.URI+"/oauth/revoke";if(!this.refreshToken||!this.clientId)return Promise.resolve();var n={token:this.refreshToken,client_id:this.clientId,client_udid:this.clientUuid,client_info:this.clientInfo,audience:this.appId,scope:JSON.stringify(this.sdk)};return this.setRefreshToken(null),e.refreshCount=0,(new c).post({url:t,data:n,headers:{"Content-Type":"application/json",Accept:"text/json"}})},e.prototype.isReady=function(){return!!this.URI},e}();p.refreshCount=0;var u=function(){function e(e,t){this._sdk=e,this._storage=t,this._client=null,this._user=null,this._cryptoSalt=this._storage.get("_cryptoSalt")||null,this.accessToken=this._storage.get("accessToken")||null,this.accessTokenPrevious=this._storage.get("accessTokenPrevious")||null,this.idToken=this._storage.get("idToken")||null,this.refreshToken=this._storage.get("refreshToken")||null,this.states=this._storage.get("states")||{},this.endpoints=[]}return e.prototype.isReady=function(){return!!this._client&&this._client.isReady()},e.prototype.destroy=function(){this._storage.remove("accessToken"),this._storage.remove("idToken"),this._storage.remove("refreshToken"),this._storage.remove("states"),this._storage.remove("_cryptoSalt"),this.accessToken&&(this.accessTokenPrevious=this.accessToken,this._storage.set("accessTokenPrevious",this.accessTokenPrevious)),this._user=null,this._client&&this._client.setClientId(null),this.accessToken=null,this.idToken=null,this.refreshToken=null,this.states={}},e.prototype.setClient=function(e){this._client=e,this._user||(this._user={}),this._user._id=this._client.clientId,this._user._name=JSON.parse(this.getIdPayload({name:""})).name},e.prototype.setUser=function(e){this._user=e,this._user._id&&this._client.setClientId(this._user._id)},e.prototype.getUser=function(){return this._user},e.prototype.getUserId=function(){return this._user?this._user._id:null},e.prototype.getClient=function(){return this._client},e.prototype.setCryptoSalt=function(e){this._cryptoSalt=e,this._storage.set("_cryptoSalt",this._cryptoSalt)},e.prototype.encrypt=function(e){if("string"!=typeof e&&(e=JSON.stringify(e)),this.miappCrypto&&this._cryptoSalt){var t=this._cryptoSalt;return s.encrypt(e,t)}return e},e.prototype.decrypt=function(e){var t=e;if(this.miappCrypto&&this._cryptoSalt){var n=this._cryptoSalt;t=s.decrypt(e,n)}try{t=JSON.parse(t)}catch(i){}return t},e.prototype.isLogin=function(){var e=!0;try{var t=this.refreshToken.split(".")[1],n=JSON.parse(r.decode(t));e=(new Date).getTime()/1e3>=n.exp}catch(i){}return!e},e.prototype.getClientId=function(){return this._client?this._client.clientId:null},e.prototype.getIdPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.idToken.split(".")[1];if(t)return r.decode(t)}catch(n){}return e||null},e.prototype.getAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessToken.split(".")[1];if(t)return r.decode(t)}catch(n){}return e||null},e.prototype.getPreviousAccessPayload=function(e){e&&"string"!=typeof e&&(e=JSON.stringify(e));try{var t=this.accessTokenPrevious.split(".")[1];if(t)return r.decode(t)}catch(n){}return e||null},e.prototype.refreshConnection=function(){var e=this,t=0;if(this.accessToken){var n=this.accessToken.split(".")[1],i=r.decode(n);if((new Date).getTime()/1e3<JSON.parse(i).exp)return Promise.resolve(t)}if(this.refreshToken){n=this.refreshToken.split(".")[1],i=r.decode(n);(new Date).getTime()/1e3>=JSON.parse(i).exp&&this._storage.remove("refreshToken")}return this.accessTokenPrevious=this.accessToken,this._storage.set("accessTokenPrevious",this.accessTokenPrevious),this._storage.remove("accessToken"),this._storage.remove("idToken"),this.accessToken=null,this.idToken=null,new Promise(function(n,i){e.getClient().reAuthenticate().then(function(t){e.setConnection(t),n(t)})["catch"](function(e){e&&408===e.code?t=408:e&&404===e.code?t=404:e&&410===e.code?t=403:e&&(t=403),n(t)})})},e.prototype.setConnection=function(e){if(e.access_token){this.accessToken=e.access_token,this._storage.set("accessToken",this.accessToken),delete e.access_token;var t=JSON.parse(this.getAccessPayload({salt:""})).salt;t&&this.setCryptoSalt(t)}e.id_token&&(this.idToken=e.id_token,this._storage.set("idToken",this.idToken),delete e.id_token),e.refresh_token&&(this.refreshToken=e.refresh_token,this._storage.set("refreshToken",this.refreshToken),delete e.refresh_token),e.roles=JSON.parse(this.getIdPayload({roles:[]})).roles,e.message=JSON.parse(this.getIdPayload({message:""})).message,this.setUser(e)},e.prototype.setConnectionOffline=function(e){this.accessToken=e.accessToken,this.idToken=e.idToken,this.refreshToken=e.refreshToken,this.setUser({roles:JSON.parse(this.getIdPayload({roles:[]})).roles,message:JSON.parse(this.getIdPayload({message:""})).message,_id:"demo"})},e.prototype.getEndpoints=function(e){var t,n=["https://miapp.io/api","https://miapp-proxy.herokuapp.com/api"],i=[];(this._sdk.prod||(n=["http://localhost:5894/api","https://miapp-sandbox.herokuapp.com/api"]),this.accessToken)&&((t=JSON.parse(this.getAccessPayload({endpoints:{}})).endpoints).length&&(n=[],t.forEach(function(e){n.push(e.uri)})));this.accessTokenPrevious&&((t=JSON.parse(this.getPreviousAccessPayload({endpoints:{}})).endpoints).length&&t.forEach(function(e){n.indexOf(e.uri)<0&&n.push(e.uri)}));if(e&&e.filter&&"theBestOne"===e.filter)if(this.states&&Object.keys(this.states).length)for(var r=0;r<n.length&&0===i.length;r++){var o=n[r];this.states[o]&&this.states[o].state&&i.push(o)}else n.length&&(i=[n[0]]);else i=n;return i},e.prototype.getDBs=function(e){if(!this.accessToken)return[];var t=Math.random()%2,n=JSON.parse(this.getAccessPayload({dbs:[]})).dbs||[];0===t?n=n.sort():1===t&&(n=n.reverse());var i=[];if(e&&e.filter&&"theBestOne"===e.filter)if(this.states&&Object.keys(this.states).length)for(var r=0;r<n.length&&0===i.length;r++){var o=n[r];this.states[o].state&&i.push(o)}else n.length&&(i=[n[0]]);else i=n;return i},e.prototype.verifyConnectionStates=function(){var e=this,t=(new Date).getTime(),n=[];return this.states={},this.endpoints=this.getEndpoints(),this.endpoints.forEach(function(i){n.push(new Promise(function(n,r){(new c).get({url:i+"/status?isok="+e._sdk.version,headers:{"Content-Type":"application/json",Accept:"text/json"}}).then(function(r){var o=!1;r&&r.isok&&(o=!0),e.states[i]={state:o,time:t},n()})["catch"](function(r){e.states[i]={state:!1,time:t},n()})}))}),this.getDBs().forEach(function(i){n.push(new Promise(function(n,r){(new c).get({url:i,headers:{"Content-Type":"application/json",Accept:"text/json"}}).then(function(r){e.states[i]={state:!0,time:t},n()})["catch"](function(r){e.states[i]={state:!1,time:t},n()})}))}),Promise.all(n)},e}(),h=window.PouchDB||require("pouchdb")["default"],d=function(){function e(){this.db=null,this.dbRecordCount=0,this.dbLastSync=null,this.remoteDb=null,this.dbs=[]}return e.prototype.isReady=function(){return!!this.db},e.prototype.create=function(e){!e&&this.db||(this.dbRecordCount=0,this.dbLastSync=(new Date).getTime(),this.db={},this.db=new h("miapp_db"))},e.prototype.destroy=function(){var e=this,t=function(){e.dbRecordCount=0,e.dbLastSync=null};return this.db?this.db&&!this.db.destroy?Promise.reject("miapp.sdk.service._removeSession : DB clean impossible."):new Promise(function(n,i){e.db.destroy(function(e,r){e?i(e):(t(),n())})}):(t(),Promise.resolve())},e.prototype.setRemote=function(e){this.dbs=e},e.prototype.sync=function(e){var t=this;return this.db?this.dbs&&this.dbs.length?new Promise(function(n,i){try{t.remoteDb&&t.remoteUri===t.dbs[0]||(t.remoteUri=t.dbs[0],t.remoteDb=new h(t.remoteUri)),t.db.sync(t.remoteDb,{filter:function(t){if(e)return t&&t.miappUserId===e?t:void 0}}).on("complete",function(e){return n(e)}).on("error",function(e){return i({code:401,msg:e})}).on("denied",function(e){return i({code:403,msg:e})})}catch(r){i({code:500,msg:r})}}):Promise.reject({code:408,msg:"need db remote"}):Promise.reject({code:408,msg:"need db"})},e.prototype.put=function(e,t,n,i,r,o){var s=this;if(!this.db)return Promise.reject("need db");if(!(e&&t&&n&&i&&r))return Promise.reject("need formated data");var a=JSON.parse(JSON.stringify(e));delete a._id,delete a._rev,delete a.miappUserId,delete a.miappOrgId,delete a.miappAppVersion,delete a.miappData;var c=this.write(this.value(a));o&&(c=o.obj[o.method](c));var p={_id:t,miappUserId:n,miappOrgId:i,miappAppVersion:r,miappData:c};return new Promise(function(e,t){s.db.put(p,function(n,i){i&&i.ok&&i.id&&i.rev?(s.dbRecordCount++,e(i.id)):t(n)})})},e.prototype.remove=function(e){var t=this;return this.db?new Promise(function(n,i){t.db.get(e).then(function(e){return e._deleted=!0,t.db.put(e)}).then(function(e){n()})["catch"](function(e){i(e)})}):Promise.reject("need db")},e.prototype.get=function(e,t){var n=this;return this.db?new Promise(function(i,r){n.db.get(e).then(function(e){if(e&&e.miappData){var n=e.miappData,o=n=t?t.obj[t.method](n):JSON.parse(n);o._id=e._id,o._rev=e._rev,o=JSON.parse(JSON.stringify(o)),i(o)}else r("none")})["catch"](function(e){return r(e)})}):Promise.reject("need db")},e.prototype.getAll=function(e){var t=this;return this.db?new Promise(function(n,i){t.db.allDocs({include_docs:!0,descending:!0}).then(function(t){var i=[];t.rows.forEach(function(t){if(t&&t.doc.miappData&&t.doc._id){var n=t.doc.miappData,r=n=e?e.obj[e.method](n):JSON.parse(n);r._id=t.doc._id,r._rev=t.doc._rev,r=JSON.parse(JSON.stringify(r)),i.push(r)}}),n(i)})["catch"](function(e){return i(e)})}):Promise.reject("need db")},e.prototype.isEmpty=function(){var e=this;return this.db?new Promise(function(t,n){e.db.allDocs({}).then(function(i){i?(e.dbRecordCount=i.total_rows,i.total_rows&&i.total_rows>0?t(!1):t(!0)):n()})["catch"](function(e){return n(e)})}):Promise.reject("need db")},e.prototype.info=function(){return this.db?this.db.info():Promise.reject("none")},e.prototype.write=function(e){var t="null",n=typeof e;return"undefined"===n?t="null":null===t?t="null":"string"===n?t=JSON.stringify({string:e}):"number"===n?t=JSON.stringify({number:e}):"boolean"===n?t=JSON.stringify({bool:e}):"object"===n&&(t=JSON.stringify({json:e})),t},e.prototype.value=function(e){return"object"!==typeof e?e:"string"in e?e.string:"number"in e?e.number.valueOf():"bool"in e?e.bool.valueOf():"json"in e?e.json:e},e}(),l=function(){function e(e,t){this.sdk={org:"miapp.io",version:i,prod:!1},this.logger={log:function(){},error:function(){},warn:function(){}},e&&(this.logger=e),this.logger.log("miapp.sdk.service : constructor"),t&&(this.promise=t),this.storage=new o(window.localStorage,"miapp."),this.session=new d,this.connection=new u(this.sdk,this.storage)}return e.prototype.miappInit=function(e,t){var n=this;return n.logger.log("miapp.sdk.service.miappInit : ",t),e?(n.sdk.prod=!t||!!t.prod,new n.promise(function(i,r){n.connection.verifyConnectionStates().then(function(){n.connection.miappId=e,n.connection.miappVersion=n.sdk.version,n.connection.miappCrypto=!!t&&!!t.crypto;var o=n.connection.getEndpoints({filter:"theBestOne"})[0];!o&&n.sdk.prod?(n.logger.warn("miapp.sdk.service.miappInit : no endpoint is nowly available, switch to dev mode."),r("miapp.sdk.service.miappInit: endpoint connection required")):(n.connection.setClient(new p(n.connection.miappId,o,n.storage,n.sdk)),i())})["catch"](function(e){n.logger.error("miapp.sdk.service.miappInit : ",e),r("miapp.sdk.service.miappInit: "+e.toString())})})):(n.logger.error("miapp.sdk.service.miappInit : bad init"),n.promise.reject("miapp.sdk.service.miappInit : bad init"))},e.prototype.miappLogin=function(e,t){var n=this;return n.logger.log("miapp.sdk.service.miappLogin"),n.connection.isReady()?new n.promise(function(i,r){n._removeAll().then(function(){return n.connection.verifyConnectionStates()}).then(function(){return n._createSession(),n._loginInternal(e,t)}).then(function(e){n.connection.setConnection(e),n.session.sync(n.connection.getUserId()).then(function(){return i(n.connection.getUser())})["catch"](function(e){return i(n.connection.getUser())})})["catch"](function(e){n.logger.error("miapp.sdk.service.miappLogin error: ",e),r(e)})}):n.promise.reject("miapp.sdk.service.miappLogin : Did you miapp.sdk.service.miappInit() ?")},e.prototype.miappLoginInDemoMode=function(e){var t=this;if(!e||!e.accessToken){var n=new Date;n.setDate(n.getDate()+1);var i=n.getTime(),o=r.encode(JSON.stringify({roles:[],message:"demo",endpoints:{},dbs:[],exp:i})),s=r.encode(JSON.stringify({})),a=s+"."+o+"."+s;e={accessToken:a,idToken:a,refreshToken:a}}return new t.promise(function(n,i){t._removeAll().then(function(){t._createSession(),t.connection.setConnectionOffline(e),n(t.connection.getUser())})["catch"](function(e){t.logger.error("miapp.sdk.service.miappLogin error: ",e),i(e)})})},e.prototype.miappRoles=function(){return JSON.parse(this.connection.getIdPayload({roles:[]})).roles},e.prototype.miappMessage=function(){return JSON.parse(this.connection.getIdPayload({message:""})).message},e.prototype.miappIsLogin=function(){return this.connection.isLogin()},e.prototype.miappLogout=function(){var e=this;return e.connection.getClient()?e.connection.getClient().logout().then(function(){return e._removeAll()})["catch"](function(){return e._removeAll()}):e._removeAll()},e.prototype.miappSync=function(e,t){var n=this;if(n.logger.log("miapp.sdk.service.miappSync"),!n.connection.isReady())return n.promise.reject("miapp.sdk.service.miappSync : DB sync impossible. Did you login ?");var i=null===n.session.dbLastSync;return new n.promise(function(r,o){n._createSession(),n.session.sync(n.connection.getUserId()).then(function(){return n.logger.log("miapp.sdk.service.miappSync resolved"),n.session.isEmpty()})["catch"](function(e){return n.logger.warn("miapp.sdk.service.miappSync warn: ",e),n.session.isEmpty()}).then(function(r){if(n.logger.log("miapp.sdk.service.miappSync isEmpty : ",r,i),r&&i&&e){var o=e(t);if(o&&o["catch"]instanceof Function)return o;"string"==typeof o&&n.logger.log(o)}return n.promise.resolve()}).then(function(){return n.logger.log("miapp.sdk.service.miappSync fnInitFirstData resolved"),n.session.dbLastSync=(new Date).getTime(),n.session.info()}).then(function(e){return n.session.dbRecordCount=0,e&&e.doc_count&&(n.session.dbRecordCount=e.doc_count),n.logger.log("miapp.sdk.service.miappSync _dbRecordCount : "+n.session.dbRecordCount),n.connection.refreshConnection()}).then(function(e){403===e?o({code:e,msg:"unauthorized (need login)"}):r()})["catch"](function(e){var t="miapp.sdk.service.miappSync err : "+e.toString();o({code:500,msg:t})})})},e.prototype.miappPutInDb=function(e){var t,n,i=this;return i.logger.log("miapp.sdk.service.miappPutInDb :",e),i.connection.getClientId()&&i.session.isReady()?(e&&"object"==typeof e&&Object.keys(e).indexOf("_id")&&(t=e._id),t||(t=i._generateObjectUniqueId(i.connection.miappId)),i.connection.miappCrypto&&(n={obj:i.connection,method:"encrypt"}),i.session.put(e,t,i.connection.getClientId(),i.sdk.org,i.connection.miappVersion,n)):i.promise.reject("miapp.sdk.service.miappPutInDb : DB put impossible. Need a user logged in.")},e.prototype.miappRemoveInDb=function(e){var t=this;return t.logger.log("miapp.sdk.service.miappRemoveInDb ",e),t.session.isReady()?e&&"string"==typeof e?t.session.remove(e):t.promise.reject("miapp.sdk.service.miappRemoveInDb : DB put impossible. Need the data._id."):t.promise.reject("miapp.sdk.service.miappRemoveInDb : DB put impossible. Need a user logged in.")},e.prototype.miappFindInDb=function(e){var t,n=this;return n.connection.getClientId()&&n.session.isReady()?(n.connection.miappCrypto&&(t={obj:n.connection,method:"decrypt"}),n.session.get(e,t)):n.promise.reject("miapp.sdk.service.miappFindInDb : need a user logged in.")},e.prototype.miappFindAllInDb=function(){var e,t=this;return t.connection.getClientId()&&t.session.isReady()?(t.connection.miappCrypto&&(e={obj:t.connection,method:"decrypt"}),t.session.getAll(e)):t.promise.reject("miapp.sdk.service.miappFindAllInDb : need a user logged in.")},e.prototype._loginInternal=function(e,t,n){var i=this;return i.logger.log("miapp.sdk.service._loginInternal"),i.connection.isReady()?new i.promise(function(r,o){i.connection.getClient().logout().then(function(r){return i.connection.getClient().login(e,t,n)}).then(function(t){t.email=e,r(t)})["catch"](function(e){i.logger.error("miapp.sdk.service._loginInternal error : "+e),o(e)})}):i.promise.reject("miapp.sdk.service._loginInternal : need init")},e.prototype._removeAll=function(){return this.connection.destroy(),this.session.destroy()},e.prototype._createSession=function(){var e=this.connection.getDBs();this.session.create(),this.session.setRemote(e)},e.prototype._testPromise=function(e){return e?this.promise.resolve("test promise ok "+e):new this.promise(function(e,t){e("test promise ok")})},e.prototype._generateObjectUniqueId=function(t,n,i){var r=new Date,o=""+r.getFullYear()+r.getMonth()+r.getDate()+r.getHours()+r.getMinutes(),s=++e._srvDataUniqId,a="";return t&&t.charAt(0)&&(a+=t.charAt(0)+""),n&&n.length>3&&(a+=n.substring(0,4)),i&&i.length>3&&(a+=i.substring(0,4)),a+=o+""+s},e}();l._srvDataUniqId=0;var f=function(){function e(){this.miappService=null,this.promise=null,this.logger=new g,this.promise=Promise,this.miappService=null}return e.prototype.init=function(e,t){return this.miappService||(this.miappService=new l(this.logger,this.promise)),this.miappService.miappInit(e,t)},e.prototype.login=function(e,t){return this.miappService?this.miappService.miappLogin(e,t):this.promise.reject("miapp.sdk.angular2.login : not initialized.")},e.prototype.loginAsDemo=function(e){return this.miappService?this.miappService.miappLoginInDemoMode(e):this.promise.reject("miapp.sdk.angular2.loginAsDemo : not initialized.")},e.prototype.isLoggedIn=function(){return this.miappService?this.miappService.miappIsLogin():this.promise.reject("miapp.sdk.angular2.isLoggedIn : not initialized.")},e.prototype.getRoles=function(){return this.miappService?this.miappService.miappRoles():[]},e.prototype.getEndpoints=function(){return this.miappService?this.miappService.getEndpoints():[]},e.prototype.logout=function(){return this.miappService?this.miappService.miappLogout():this.promise.reject("miapp.sdk.angular2.logout : not initialized.")},e.prototype.sync=function(e){return this.miappService?this.miappService.miappSync(e,this):this.promise.reject("miapp.sdk.angular2.sync : not initialized.")},e.prototype.put=function(e){return this.miappService?this.miappService.miappPutInDb(e):this.promise.reject("miapp.sdk.angular2.put : not initialized.")},e.prototype.remove=function(e){return this.miappService?this.miappService.miappRemoveInDb(e):this.promise.reject("miapp.sdk.angular2.remove : not initialized.")},e.prototype.find=function(e){return this.miappService?this.miappService.miappFindInDb(e):this.promise.reject("miapp.sdk.angular2.find : not initialized.")},e.prototype.findAll=function(){return this.miappService?this.miappService.miappFindAllInDb():this.promise.reject("miapp.sdk.angular2.findAll : not initialized.")},e}();f.decorators=[{type:t.Injectable}],f.ctorParameters=function(){return[]};var g=function(){function e(){}return e.prototype.log=function(e){},e.prototype.error=function(e){console.error(e)},e.prototype.warn=function(e){console.warn(e)},e}(),m=function(){return function(){}}();m.decorators=[{type:t.NgModule,args:[{imports:[n.CommonModule],declarations:[],exports:[],providers:[f]}]}],m.ctorParameters=function(){return[]},e.MiappModule=m,e.MiappService=f,e.LoggerService=g,Object.defineProperty(e,"__esModule",{value:!0})});
//# sourceMappingURL=miappio-sdk.umd.min.js.map
